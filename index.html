<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Surat RSUD dr. R. Koesma</title>
    <link rel="icon" type="image/png" href="https://github.com/koesmasurat/1/blob/main/new%20logo%20rsud%202025%20kecil.png?raw=true">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --main-color: #f59e0b;
            --main-color-light: #fcd34d;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('https://images.unsplash.com/photo-1557682250-33bd709cbe85?q=80&w=2670&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .active-link { 
            border-left: 4px solid var(--main-color-light); 
            background-color: rgba(255, 255, 255, 0.15); 
            font-weight: 600; 
            color: white;
        }
        .glass-card {
            background: rgba(20, 10, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .form-input {
            background: rgba(0,0,0,0.2) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            color: white !important;
        }
        .form-input::placeholder { color: rgba(255,255,255,0.5) !important; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); z-index: 9999; justify-content: center; align-items: center; }
        .modal { display: none; }
        .pagination-btn {
            padding: 0.5rem 1rem; border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1); color: white;
            border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.2s;
        }
        .pagination-btn:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.2); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active { background-color: var(--main-color); font-weight: bold; }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-diarsipk-an { background-color: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        .status-sudah-disposisi { background-color: rgba(245, 158, 11, 0.3); color: #fcd34d; }
    </style>
</head>
<body class="min-h-screen">

    <div id="loading-overlay" class="loading-overlay">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div id="app" class="flex">
        <div id="sidebar" class="hidden fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out w-64 glass-card z-40 m-2 rounded-2xl flex-shrink-0 flex flex-col h-[calc(100vh-1rem)]">
            <div class="p-4 border-b border-white/20 text-center flex-shrink-0">
                <img id="sidebar-profile-pic" src="https://ui-avatars.com/api/?name=User&background=f59e0b&color=fff" alt="Foto Profil" class="w-20 h-20 mx-auto mb-2 rounded-full border-2 border-amber-400 object-cover">
                <h2 id="sidebar-user-name" class="text-lg font-bold text-white">Nama User</h2>
                <p class="text-xs text-gray-300">SIMAS RSUD dr. R. Koesma</p>
            </div>
            <nav class="mt-4 flex-grow overflow-y-auto">
                <a href="#dashboard" onclick="showPage('dashboard')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span></a>
                <a href="#surat-masuk" id="nav-surat-masuk" onclick="showPage('surat-masuk')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="mail-check" class="w-5 h-5"></i><span>Surat Masuk</span></a>
                <a href="#surat-keluar" id="nav-surat-keluar" onclick="showPage('surat-keluar')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="send" class="w-5 h-5"></i><span>Surat Keluar</span></a>
                <a href="#disposisi" onclick="showPage('disposisi')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="layers-3" class="w-5 h-5"></i><span>Inbox Disposisi</span></a>
                <a href="#arsip" onclick="showPage('arsip')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="archive" class="w-5 h-5"></i><span>Arsip Dokumen</span></a>
                <a href="#profil" onclick="showPage('profil')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="user-circle" class="w-5 h-5"></i><span>Profil Saya</span></a>
                <a href="#users" id="nav-users" onclick="showPage('users')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="users" class="w-5 h-5"></i><span>Manajemen User</span></a>
                <a href="#log" id="nav-log" onclick="showPage('log')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3"><i data-lucide="file-text" class="w-5 h-5"></i><span>Log Aktivitas</span></a>
            </nav>
            <div class="p-6 w-full border-t border-white/20 flex-shrink-0">
                <button onclick="logout()" class="w-full text-left flex items-center space-x-3 text-red-400 hover:text-red-300 transition duration-150"><i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span></button>
            </div>
        </div>
        
        <div id="content-area" class="flex-1 transition-all duration-300 p-2 md:p-4 min-w-0">
            <button id="menu-toggle" class="md:hidden p-2 rounded-full glass-card mb-4 fixed top-4 right-4 z-50"><i data-lucide="menu" class="w-6 h-6 text-white"></i></button>

            <div id="pages-container">
                <div id="login-page" class="page max-w-md mx-auto mt-20 p-8 glass-card">
<div class="flex justify-center mb-4"><img src="https://github.com/koesmasurat/1/blob/main/new%20logo%20rsud%202025%20kecil.png?raw=true" alt="Logo RSUD" class="w-20 h-20 rounded-full"></div>

                    <h2 class="text-2xl font-bold mb-6 text-center text-white">Login SIMAS RSUD</h2>
                    <p class="text-sm text-center text-red-400 mb-4" id="login-error-message"></p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-userid" class="block text-sm font-medium text-gray-200">User ID</label>
                            <input type="text" id="login-userid" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm form-input" placeholder="Masukkan User ID Anda">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-200">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm form-input">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700">Masuk</button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-300">Belum punya akun? <a href="#" onclick="showPage('register')" class="font-medium text-amber-400 hover:text-amber-300">Daftar Sekarang</a></p>
                </div>
                
                <div id="register-page" class="page max-w-lg mx-auto mt-10 p-8 glass-card hidden">
<div class="flex justify-center mb-4"><img src="https://github.com/koesmasurat/1/blob/main/new%20logo%20rsud%202025%20kecil.png?raw=true" alt="Logo RSUD" class="w-20 h-20 rounded-full"></div>

                    <h2 class="text-2xl font-bold mb-6 text-center text-white">Pendaftaran Akun Baru</h2>
                    <p class="text-sm text-center text-red-400 mb-4" id="register-error-message"></p>
                    <form id="register-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                                <label for="reg-nama" class="block text-sm font-medium text-gray-200">Nama Lengkap</label>
                                <input type="text" id="reg-nama" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="reg-userid" class="block text-sm font-medium text-gray-200">User ID (untuk login)</label>
                                <input type="text" id="reg-userid" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="reg-jabatan-level" class="block text-sm font-medium text-gray-200">Jabatan & Level</label>
                                <select id="reg-jabatan-level" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                                    <option value="">Pilih Jabatan</option>
                                    <option value='{"jabatan": "Direktur", "level": 2}'>Direktur (Level 2)</option>
                                    <option value='{"jabatan": "Wadir Adminkeu", "level": 3}'>Wadir Adminkeu (Level 3)</option>
                                    <option value='{"jabatan": "Wadir Pelayanan", "level": 3}'>Wadir Pelayanan (Level 3)</option>
                                    <option value='{"jabatan": "Kabag", "level": 4}'>Kabag (Level 4)</option>
                                    <option value='{"jabatan": "Kabid", "level": 4}'>Kabid (Level 4)</option>
                                    <option value='{"jabatan": "JFT", "level": 5}'>JFT (Level 5)</option>
                                    <option value='{"jabatan": "Staf", "level": 6}'>Staf (Level 6)</option>
                                </select>
                            </div>
                            <div>
                                <label for="reg-wa" class="block text-sm font-medium text-gray-200">Nomor WA</label>
                                <input type="text" id="reg-wa" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm" placeholder="6281xxxx">
                            </div>
                             <div class="md:col-span-2">
                                <label for="reg-email" class="block text-sm font-medium text-gray-200">Email (Opsional)</label>
                                <input type="email" id="reg-email" class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="reg-password" class="block text-sm font-medium text-gray-200">Password</label>
                            <input type="password" id="reg-password" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                        </div>
                        <button type="submit" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700">
                            Daftar
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-300">Sudah punya akun? <a href="#" onclick="showPage('login')" class="font-medium text-amber-400 hover:text-amber-300">Login</a></p>
                </div>

                <div id="dashboard-page" class="page hidden text-white">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-3xl font-bold">Dashboard</h2>
                        <button onclick="loadDashboardData()" class="bg-amber-600/80 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700">Refresh Data</button>
                    </div>
                    <p class="text-md text-gray-200 mb-6">Selamat datang, <span id="user-display-name" class="font-semibold"></span>! Jabatan: <span id="user-display-jabatan" class="font-semibold"></span></p>
                    <div id="dashboard-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="p-6 glass-card border-t-4 border-sky-400">
                                <p id="dashboard-card-title-surat-masuk" class="text-sm font-medium text-gray-200">Surat Masuk Bulan Ini</p>
                                <p class="text-3xl font-bold mt-1" id="stat-masuk">0</p>
                            </div>
                            <div class="p-6 glass-card border-t-4 border-amber-400">
                                <p class="text-sm font-medium text-gray-200">Tugas Belum Ditindaklanjuti</p>
                                <p class="text-3xl font-bold mt-1" id="stat-unread">0</p>
                            </div>
                        </div>
                        <div class="p-6 glass-card">
                            <h3 class="text-xl font-semibold mb-4">Disposisi Terbaru untuk Anda</h3>
                            <div id="disposisi-list-dashboard"><p class="text-gray-200">Memuat data...</p></div>
                        </div>
                    </div>
                </div>
                
                <div id="profil-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Profil Saya</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 flex flex-col items-center p-6 glass-card">
                             <img id="profile-pic-display" src="https://ui-avatars.com/api/?name=User&background=f59e0b&color=fff&size=128" alt="Foto Profil" class="w-32 h-32 mb-4 rounded-full border-4 border-amber-400 object-cover">
                             <input type="file" id="profile-pic-input" class="hidden" accept="image/png, image/jpeg">
                             <div class="flex space-x-2">
                                <button onclick="document.getElementById('profile-pic-input').click()" class="bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                                    <i data-lucide="camera" class="w-5 h-5 mr-2"></i> Ubah Foto
                                </button>
                                <button id="remove-pic-btn" onclick="handleRemoveProfilePic()" class="bg-red-600 text-white px-3 py-2 rounded-lg shadow-md hover:bg-red-700 transition duration-150 flex items-center">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                             </div>
                            <p class="text-xs text-gray-400 mt-2">Max. 5MB (JPG/PNG)</p>
                        </div>
                        
                        <div class="md:col-span-2 space-y-6">
                            <div class="p-6 glass-card">
                                <h3 class="text-xl font-semibold mb-4 border-b border-white/20 pb-2">Informasi Pribadi</h3>
                                <form id="profile-info-form">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-200">Nama Lengkap</label>
                                            <input type="text" id="profile-nama" required class="mt-1 block w-full px-3 py-2 form-input rounded-md">
                                        </div>
                                         <div>
                                            <label class="block text-sm font-medium text-gray-200">Nomor WA</label>
                                            <input type="text" id="profile-wa" required class="mt-1 block w-full px-3 py-2 form-input rounded-md">
                                        </div>
                                         <div>
                                            <label class="block text-sm font-medium text-gray-200">Email</label>
                                            <input type="email" id="profile-email" class="mt-1 block w-full px-3 py-2 form-input rounded-md">
                                        </div>
                                    </div>
                                    <div class="text-right mt-4">
                                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700">Simpan Info</button>
                                    </div>
                                </form>
                            </div>

                            <div class="p-6 glass-card">
                                 <h3 class="text-xl font-semibold mb-4 border-b border-white/20 pb-2">Ubah Password</h3>
                                 <form id="change-password-form">
                                     <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-200">Password Lama</label>
                                            <input type="password" id="old-password" required class="mt-1 block w-full px-3 py-2 form-input rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-200">Password Baru</label>
                                            <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 form-input rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-200">Konfirmasi Password Baru</label>
                                            <input type="password" id="confirm-new-password" required class="mt-1 block w-full px-3 py-2 form-input rounded-md">
                                        </div>
                                     </div>
                                     <p id="password-form-message" class="text-sm my-4 hidden"></p>
                                     <div class="text-right mt-4">
                                        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-700">Ubah Password</button>
                                    </div>
                                 </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="surat-masuk-page" class="page hidden text-white">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">Daftar Surat Masuk</h2>
                        <button onclick="loadSuratData('Masuk', 1)" class="bg-amber-600/80 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i> Refresh Data
                        </button>
                    </div>
                     <button id="btn-tambah-surat" onclick="openTambahSuratModal()" class="mb-6 bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Tambah Surat Masuk
                    </button>
                    <div class="p-6 glass-card">
                        <div class="mb-4 flex gap-2">
                            <input type="text" id="search-surat-masuk" placeholder="Cari: Nomor/Perihal/Pengirim" class="w-full px-3 py-2 form-input rounded-md">
                             <button onclick="handleSearch('surat-masuk')" class="bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                                <i data-lucide="search" class="w-5 h-5 mr-2"></i> Cari
                            </button>
                        </div>
                        <div id="surat-masuk-list" class="overflow-x-auto"></div>
                        <div id="pagination-surat-masuk" class="mt-4 flex justify-between items-center text-sm"></div>
                    </div>
                </div>
                
                <div id="surat-keluar-page" class="page hidden text-white"><h2 class="text-3xl font-bold mb-6">Daftar Surat Keluar</h2></div>
                
                <div id="disposisi-page" class="page hidden text-white">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">Inbox Disposisi</h2>
                        <button onclick="loadMyDisposisi(1)" class="bg-amber-600/80 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i> Refresh Data
                        </button>
                    </div>
                    <div class="p-6 glass-card">
                        <div class="mb-4 flex gap-2">
                            <input type="text" id="search-disposisi" placeholder="Cari: No Surat/Perihal/Pengirim/Catatan" class="w-full px-3 py-2 form-input rounded-md">
                             <button onclick="handleSearch('disposisi')" class="bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                                <i data-lucide="search" class="w-5 h-5 mr-2"></i> Cari
                            </button>
                        </div>
                        <div id="my-disposisi-list" class="overflow-x-auto"></div>
                         <div id="pagination-disposisi" class="mt-4 flex justify-between items-center text-sm"></div>
                    </div>
                </div>
                
                <div id="arsip-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Arsip Dokumen</h2>
                    <p class="text-gray-200 mb-6">Lihat semua arsip surat yang tersimpan di sistem.</p>
                    <div class="p-6 glass-card">
                         <div class="mb-4 flex gap-2">
                            <input type="text" id="search-arsip" placeholder="Cari: Nomor/Perihal/Pengirim" class="w-full px-3 py-2 form-input rounded-md">
                             <button onclick="handleSearch('arsip')" class="bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                                <i data-lucide="search" class="w-5 h-5 mr-2"></i> Cari
                            </button>
                        </div>
                        <div id="arsip-list" class="overflow-x-auto"></div>
                        <div id="pagination-arsip" class="mt-4 flex justify-between items-center text-sm"></div>
                    </div>
                </div>
                
                <div id="users-page" class="page hidden text-white">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">Manajemen User</h2>
                        <button onclick="openUserModal()" class="bg-amber-600/80 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Tambah User Baru
                        </button>
                    </div>
                    <div id="user-management-content" class="p-6 glass-card overflow-x-auto"></div>
                </div>
                
                <div id="log-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Log Aktivitas Sistem</h2>
                    <div id="log-content" class="p-6 glass-card" style="max-height: 80vh; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-tambah-surat" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-5 w-full max-w-2xl glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">Input Surat Masuk</h3>
            <form id="form-surat">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Nomor Surat</label>
                    <input type="text" id="surat-nomor" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Perihal</label>
                    <input type="text" id="surat-perihal" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Tanggal Surat</label>
                    <input type="date" id="surat-tanggal" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200" id="label-pengirim">Pengirim</label>
                    <input type="text" id="surat-pengirim" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Upload File (PDF/DOCX/JPG/PNG)</label>
                    <input type="file" id="surat-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required class="mt-1 block w-full text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100">
                </div>
                <div id="surat-form-message" class="text-sm text-red-400 mb-4"></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="document.getElementById('modal-tambah-surat').style.display='none';" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">Simpan & Kirim ke Direktur</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-disposisi" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-5 w-full max-w-xl glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">Disposisi Lanjut Surat</h3>
            <p class="text-sm text-amber-300 mb-4" id="dispo-surat-nomor"></p>
            <form id="form-disposisi">
                <input type="hidden" id="dispo-surat-id"><input type="hidden" id="dispo-parent-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Pilih Penerima Disposisi</label>
                    <div id="dispo-penerima-list" class="mt-2 max-h-48 overflow-y-auto space-y-2 p-3 bg-black/20 rounded-md"></div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Instruksi/Catatan</label>
                    <textarea id="dispo-catatan" rows="3" class="mt-1 block w-full px-3 py-2 rounded-md form-input"></textarea>
                </div>
                <div id="dispo-form-message" class="text-sm text-red-400 mb-4"></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="document.getElementById('modal-disposisi').style.display='none';" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">Kirim Disposisi</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-user-form" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-6 w-full max-w-lg glass-card">
            <h3 id="user-form-title" class="text-xl font-bold mb-4 text-white">Form User</h3>
            <form id="user-form">
                <input type="hidden" id="user-form-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="user-form-nama" class="block text-sm font-medium text-gray-200">Nama Lengkap</label>
                        <input type="text" id="user-form-nama" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="user-form-userid" class="block text-sm font-medium text-gray-200">User ID (login)</label>
                        <input type="text" id="user-form-userid" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="user-form-jabatan-level" class="block text-sm font-medium text-gray-200">Jabatan & Level</label>
                        <select id="user-form-jabatan-level" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            <option value="">Pilih Jabatan</option>
                            <option value='{"jabatan": "Super Admin", "level": 0}'>Super Admin (Level 0)</option>
                            <option value='{"jabatan": "Admin TU", "level": 1}'>Admin TU (Level 1)</option>
                            <option value='{"jabatan": "Direktur", "level": 2}'>Direktur (Level 2)</option>
                            <option value='{"jabatan": "Wadir Adminkeu", "level": 3}'>Wadir Adminkeu (Level 3)</option>
                            <option value='{"jabatan": "Wadir Pelayanan", "level": 3}'>Wadir Pelayanan (Level 3)</option>
                            <option value='{"jabatan": "Kabag", "level": 4}'>Kabag (Level 4)</option>
                            <option value='{"jabatan": "Kabid", "level": 4}'>Kabid (Level 4)</option>
                            <option value='{"jabatan": "JFT", "level": 5}'>JFT (Level 5)</option>
                            <option value='{"jabatan": "Staf", "level": 6}'>Staf (Level 6)</option>
                        </select>
                    </div>
                    <div>
                        <label for="user-form-wa" class="block text-sm font-medium text-gray-200">Nomor WA</label>
                        <input type="text" id="user-form-wa" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm" placeholder="6281xxxx">
                    </div>
                    <div class="md:col-span-2">
                        <label for="user-form-email" class="block text-sm font-medium text-gray-200">Email (Opsional)</label>
                        <input type="email" id="user-form-email" class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                    </div>
                </div>
                <p id="user-form-notice" class="text-xs text-amber-300 mt-4 hidden">Password akan diatur default 'password123'.</p>
                <div id="user-form-message" class="text-sm text-red-400 my-4"></div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" onclick="document.getElementById('modal-user-form').style.display='none';" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="modal-custom" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-6 w-full max-w-sm glass-card">
            <h3 id="custom-modal-title" class="text-lg font-bold mb-3 text-white">Notifikasi</h3>
            <p id="custom-modal-message" class="text-sm text-gray-200 mb-6"></p>
            <div id="custom-modal-actions" class="flex justify-end space-x-2"></div>
        </div>
    </div>
    <div id="modal-riwayat" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-6 w-full max-w-2xl glass-card">
            <h3 class="text-xl font-bold text-white">Riwayat Surat</h3>
            <p id="riwayat-surat-nomor" class="text-sm text-amber-300 mb-6"></p>
            <div id="riwayat-timeline-container" class="mt-4 max-h-[60vh] overflow-y-auto pr-4"></div>
            <div class="flex justify-end mt-6">
                <button onclick="document.getElementById('modal-riwayat').style.display='none'" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwQvV3PoztdzPD4-eYznz_WKtUlNDRfLeyKPXKfxzqeLWhhdpyIa6QSFlXhMfpCuoU/exec'; 
        let currentUser = null;
        let allUsers = [];
        let confirmCallback = null;
        const ITEMS_PER_PAGE = 10;
        const DEFAULT_PIC = 'https://ui-avatars.com/api/?background=f59e0b&color=fff&size=128';

        // --- UTILITY FUNCTIONS ---
        function showMessage(elementId, message, isError = true) {
            const el = document.getElementById(elementId);
            if(el) {
                el.textContent = message;
                el.className = `text-sm my-4 ${isError ? 'text-red-400' : 'text-green-400'}`;
                el.classList.toggle('hidden', !message);
            }
        }
        function formatTanggalWaktu(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) { return isoString; }
        }
        function formatTanggal(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
                const year = adjustedDate.getFullYear();
                const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
                const day = String(adjustedDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { return isoString.split('T')[0]; }
        }
        function showCustomAlert(message, title = 'Notifikasi') {
            const modal = document.getElementById('modal-custom');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').textContent = message;
            const actions = document.getElementById('custom-modal-actions');
            actions.innerHTML = `<button onclick="document.getElementById('modal-custom').style.display='none';" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">OK</button>`;
            modal.style.display = 'flex';
        }
        function showCustomConfirm(message, callback) {
            const modal = document.getElementById('modal-custom');
            document.getElementById('custom-modal-title').textContent = 'Konfirmasi Tindakan';
            document.getElementById('custom-modal-message').textContent = message;
            confirmCallback = callback;
            const actions = document.getElementById('custom-modal-actions');
            actions.innerHTML = `
                <button id="btn-cancel" class="px-4 py-2 bg-gray-500/50 rounded-md hover:bg-gray-500/70 text-white">Batal</button>
                <button id="btn-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Ya, Lanjutkan</button>
            `;
            document.getElementById('btn-cancel').onclick = () => {
                modal.style.display = 'none';
                if (confirmCallback) confirmCallback(false);
            };
            document.getElementById('btn-confirm').onclick = () => {
                modal.style.display = 'none';
                if (confirmCallback) confirmCallback(true);
            };
            modal.style.display = 'flex';
        }
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }
        async function fetchWithRetry(url, options = {}, retries = 3) {
            let attempt = 0;
            while (attempt < retries) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const text = await response.text();
                    try { return JSON.parse(text); } 
                    catch (e) { console.error("Failed to parse JSON:", text); throw new Error("Received non-JSON response from server."); }
                } catch (error) {
                    attempt++;
                    console.warn(`Fetch attempt ${attempt} failed: ${error.message}. Retrying...`);
                    if (attempt >= retries) throw error; 
                    await new Promise(res => setTimeout(res, 1000 * attempt));
                }
            }
        }

        // --- AUTH & UI LOGIC ---
        function updateUIVisibility() {
            const isAdmin = currentUser && [0, 1].includes(parseInt(currentUser.level));
            document.getElementById('btn-tambah-surat').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('nav-surat-masuk').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('nav-users').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('nav-log').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('nav-surat-keluar').style.display = 'none';
            
            const isAdminOrTU = [0, 1].includes(parseInt(currentUser.level));
            const cardTitleEl = document.getElementById('dashboard-card-title-surat-masuk');
            if(cardTitleEl) {
                cardTitleEl.textContent = isAdminOrTU ? 'Total Surat Masuk RS Bulan Ini' : 'Disposisi Diterima Bulan Ini';
            }
        }
        function checkLoginStatus() {
            const userData = localStorage.getItem('currentUser');
            const sidebarEl = document.getElementById('sidebar');
            if (userData) {
                currentUser = JSON.parse(userData);
                document.getElementById('user-display-name').textContent = currentUser.nama;
                document.getElementById('user-display-jabatan').textContent = `${currentUser.jabatan} (Level ${currentUser.level})`;
                document.getElementById('sidebar-user-name').textContent = currentUser.nama;
                const profilePicUrl = currentUser.profile_pic_url || `${DEFAULT_PIC}&name=${encodeURIComponent(currentUser.nama)}`;
                document.getElementById('sidebar-profile-pic').src = profilePicUrl;
                sidebarEl.classList.remove('hidden');
                updateUIVisibility();
                const initialHash = window.location.hash.substring(1) || 'dashboard';
                showPage(initialHash);
            } else {
                currentUser = null;
                sidebarEl.classList.add('hidden');
                showPage('login');
            }
            lucide.createIcons(); 
        }
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link'));
                const activeLink = document.querySelector(`a[href="#${pageId}"]`);
                if (activeLink) activeLink.classList.add('active-link');
                if (currentUser) {
                    window.location.hash = pageId;
                    switch (pageId) {
                        case 'dashboard': loadDashboardData(); break;
                        case 'surat-masuk': loadSuratData('Masuk', 1); break;
                        case 'disposisi': loadMyDisposisi(1); break;
                        case 'users': loadUserManagement(); break;
                        case 'profil': loadProfileData(); break;
                        case 'log': loadLogData(); break;
                        case 'arsip': loadArsipData(1); break;
                    }
                }
            } else if (pageId === 'login' || pageId === 'register') {
                document.getElementById(pageId + '-page').classList.remove('hidden');
                window.location.hash = '';
            }
        }
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            window.location.href = window.location.pathname;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('form-surat').addEventListener('submit', handleSuratSubmit);
            document.getElementById('form-disposisi').addEventListener('submit', handleDisposisiSubmit);
            document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);
            document.getElementById('search-surat-masuk').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSearch('surat-masuk'); });
            document.getElementById('search-disposisi').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSearch('disposisi'); });
            document.getElementById('search-arsip').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleSearch('arsip'); });
            document.getElementById('profile-info-form').addEventListener('submit', handleProfileInfoUpdate);
            document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
            document.getElementById('profile-pic-input').addEventListener('change', handleProfilePicChange);
        });

        // --- API & DATA HANDLING ---
        async function handleLogin(e) {
            e.preventDefault();
            const userid = document.getElementById('login-userid').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!GAS_API_URL.startsWith('https://') || GAS_API_URL.includes('AKfycbw...')) {
                showCustomAlert('ERROR: Harap ganti variabel GAS_API_URL di dalam kode HTML.', 'Kesalahan Konfigurasi');
                return;
            }
            showLoading(true);
            try {
                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', userid, password }),
                });
                if (result.status === 'success') {
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    window.location.reload();
                } else {
                    showMessage('login-error-message', result.message || 'Login gagal.', true);
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('login-error-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        async function handleRegister(e) {
            e.preventDefault();
            const nama = document.getElementById('reg-nama').value.trim();
            const userid = document.getElementById('reg-userid').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const wa = document.getElementById('reg-wa').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const roleDataEl = document.getElementById('reg-jabatan-level');
            if (!roleDataEl.value) {
                showMessage('register-error-message', 'Jabatan & Level harus dipilih.', true);
                return;
            }
            const { jabatan, level } = JSON.parse(roleDataEl.value);
            showLoading(true);
            try {
                const payload = { action: 'register', nama, userid, password, wa, email, jabatan, level };
                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                });
                if (result.status === 'success') {
                    showMessage('register-error-message', 'Pendaftaran berhasil! Silakan login.', false);
                    document.getElementById('register-form').reset();
                    setTimeout(() => showPage('login'), 2000);
                } else {
                    showMessage('register-error-message', result.message || 'Pendaftaran gagal.', true);
                }
            } catch (error) {
                console.error('Register error:', error);
                showMessage('register-error-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        function openTambahSuratModal() {
            document.getElementById('surat-tanggal').value = new Date().toISOString().split('T')[0];
            showMessage('surat-form-message', '', false);
            document.getElementById('modal-tambah-surat').style.display = 'flex';
        }
        async function handleSuratSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('surat-file');
            if (fileInput.files.length === 0) {
                showMessage('surat-form-message', 'File surat wajib diupload.', true);
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (event) => {
                showLoading(true);
                const base64File = event.target.result.split(',')[1];
                const payload = {
                    action: 'input_surat',
                    jenis: 'Masuk',
                    nomor: document.getElementById('surat-nomor').value.trim(),
                    perihal: document.getElementById('surat-perihal').value.trim(),
                    tanggal: document.getElementById('surat-tanggal').value,
                    pengirim_penerima: document.getElementById('surat-pengirim').value.trim(),
                    fileName: file.name,
                    fileMimeType: file.type,
                    fileBase64: base64File,
                    userId: currentUser.id
                };
                try {
                    const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    if (result.status === 'success') {
                        showCustomAlert('Surat berhasil dikirim ke Direktur!', 'Berhasil');
                        document.getElementById('form-surat').reset();
                        document.getElementById('modal-tambah-surat').style.display='none';
                        loadSuratData('Masuk', 1);
                    } else {
                        showMessage('surat-form-message', result.message || 'Gagal menyimpan surat.', true);
                    }
                } catch (error) {
                    console.error('Surat submit error:', error);
                    showMessage('surat-form-message', 'Terjadi kesalahan jaringan atau server.', true);
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsDataURL(file);
        }
        async function loadSuratData(jenis, page = 1) {
            const listContainer = document.getElementById('surat-masuk-list');
            const paginationContainer = document.getElementById('pagination-surat-masuk');
            const refreshButtonIcon = document.querySelector('#surat-masuk-page button[onclick*="loadSuratData"] i');
            const searchTerm = document.getElementById('search-surat-masuk').value.trim();
            if(refreshButtonIcon) refreshButtonIcon.classList.add('animate-spin');
            listContainer.innerHTML = '<p class="text-gray-200">Memuat data surat...</p>';
            paginationContainer.innerHTML = '';
            showLoading(true);
            try {
                const url = `${GAS_API_URL}?action=get_surat_list&jenis=${jenis}&userId=${currentUser.id}&page=${page}&limit=${ITEMS_PER_PAGE}&searchTerm=${encodeURIComponent(searchTerm)}`;
                const data = await fetchWithRetry(url);
                if (data.status === 'success') {
                    renderSuratMasukList(listContainer, data.surat);
                    renderPagination('surat-masuk', paginationContainer, data.pagination, (p) => loadSuratData('Masuk', p));
                } else {
                    listContainer.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat data.'}</p>`;
                }
            } catch (error) {
                console.error(`Load Surat ${jenis} error:`, error);
                listContainer.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
                if(refreshButtonIcon) refreshButtonIcon.classList.remove('animate-spin');
            }
        }
        function renderSuratMasukList(container, suratList) {
             if (!suratList || suratList.length === 0) {
                container.innerHTML = '<p class="text-gray-200 text-center py-4">Tidak ada data surat yang ditemukan.</p>';
                return;
            }
            let html = `
            <table class="min-w-full divide-y divide-white/20">
                <thead class="bg-black/20">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Nomor Surat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Perihal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Pengirim</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Tanggal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/20">`;
            suratList.forEach(surat => {
                html += `
                    <tr class="hover:bg-black/10">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${surat.nomor_surat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.perihal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.pengirim_penerima}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${formatTanggal(surat.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="${surat.file_url}" target="_blank" class="text-amber-400 hover:text-amber-300 font-medium">Lihat File</a>
                            <button onclick="openRiwayatModal('${surat.id}', '${surat.nomor_surat.replace(/'/g, "\\'")}')" class="text-cyan-400 hover:text-cyan-300 font-medium ml-3">Riwayat</button>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        // --- DISPOSISI LOGIC ---
        async function openDisposisiModal(suratId, parentDisposisiId, suratNomor) {
            document.getElementById('dispo-surat-id').value = suratId;
            document.getElementById('dispo-parent-id').value = parentDisposisiId;
            document.getElementById('dispo-surat-nomor').textContent = `No. Surat: ${suratNomor}`;
            const recipientList = document.getElementById('dispo-penerima-list');
            
            document.getElementById('modal-disposisi').style.display='flex';
            recipientList.innerHTML = '<p class="text-gray-400">Memuat daftar penerima...</p>';
            showMessage('dispo-form-message', '', false);

            try {
                const userData = await fetchWithRetry(`${GAS_API_URL}?action=get_users&userId=${currentUser.id}`);
                if (userData.status === 'success') {
                    allUsers = userData.users;
                } else {
                    throw new Error(userData.message || 'Gagal memuat pengguna.');
                }

                recipientList.innerHTML = ''; 
                const userLevel = parseInt(currentUser.level);
                let targetLevels = [];
                
                if (userLevel === 2) targetLevels = [3, 4]; // Direktur -> Wadir (3) ATAU Kabag/Kabid (4)
                else if (userLevel === 3) targetLevels = [4];
                else if (userLevel === 4) targetLevels = [5, 6];
                
                const recipients = allUsers.filter(u => targetLevels.includes(parseInt(u.level)) && u.status === 'Aktif');
                
                if (recipients.length > 0) {
                    recipients.forEach(user => {
                        recipientList.innerHTML += `
                            <label class="flex items-center space-x-3 p-2 hover:bg-black/20 rounded-md cursor-pointer text-white">
                                <input type="checkbox" name="dispo_penerima" value="${user.id}" class="w-4 h-4 rounded text-amber-500 bg-gray-700 border-gray-600 focus:ring-amber-600">
                                <span>${user.nama} <span class="text-xs text-gray-400">(${user.jabatan})</span></span>
                            </label>`;
                    });
                } else {
                    recipientList.innerHTML = '<p class="text-gray-400">Tidak ada pengguna aktif di level selanjutnya untuk menerima disposisi.</p>';
                }

            } catch(error) {
                console.error("Failed to load users for disposition:", error);
                recipientList.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        }
        async function handleDisposisiSubmit(e) {
            e.preventDefault();
            const checkedBoxes = document.querySelectorAll('input[name="dispo_penerima"]:checked');
            const recipientIds = Array.from(checkedBoxes).map(cb => cb.value);
            if (recipientIds.length === 0) {
                 showMessage('dispo-form-message', 'Penerima disposisi wajib dipilih (minimal satu).', true);
                 return;
            }
            showLoading(true);
            const payload = {
                action: 'disposisi_surat',
                id_surat: document.getElementById('dispo-surat-id').value,
                parent_disposisi_id: document.getElementById('dispo-parent-id').value,
                dari_user_id: currentUser.id,
                ke_user_ids: recipientIds,
                catatan: document.getElementById('dispo-catatan').value.trim()
            };
            try {
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    showCustomAlert(result.message, 'Berhasil');
                    document.getElementById('form-disposisi').reset();
                    document.getElementById('modal-disposisi').style.display='none';
                    loadMyDisposisi(1);
                    if (currentUser && [0,1].includes(parseInt(currentUser.level))) {
                        loadSuratData('Masuk', 1);
                    }
                } else {
                    showMessage('dispo-form-message', result.message || 'Gagal mengirim disposisi.', true);
                }
            } catch (error) {
                console.error('Disposisi submit error:', error);
                showMessage('dispo-form-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        async function loadMyDisposisi(page = 1) {
            const container = document.getElementById('my-disposisi-list');
            const paginationContainer = document.getElementById('pagination-disposisi');
            const refreshButtonIcon = document.querySelector('#disposisi-page button i');
            const searchTerm = document.getElementById('search-disposisi').value.trim();
            if(refreshButtonIcon) refreshButtonIcon.classList.add('animate-spin');
            container.innerHTML = '<p class="text-gray-200">Memuat disposisi...</p>';
            paginationContainer.innerHTML = '';
            showLoading(true);
            try {
                const url = `${GAS_API_URL}?action=get_my_disposisi&userId=${currentUser.id}&page=${page}&limit=${ITEMS_PER_PAGE}&searchTerm=${encodeURIComponent(searchTerm)}`;
                const dispoData = await fetchWithRetry(url);
                if (dispoData.status === 'success') {
                    renderMyDisposisiList(container, dispoData.disposisi);
                    renderPagination('disposisi', paginationContainer, dispoData.pagination, loadMyDisposisi);
                } else {
                    container.innerHTML = `<p class="text-red-400">${dispoData.message || 'Gagal memuat data.'}</p>`;
                }
            } catch (error) {
                console.error('Load My Disposisi error:', error);
                container.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
                if(refreshButtonIcon) refreshButtonIcon.classList.remove('animate-spin');
            }
        }
        function renderMyDisposisiList(container, disposisiList) {
             if (!disposisiList || disposisiList.length === 0) {
                container.innerHTML = '<p class="text-gray-200 text-center py-4">Tidak ada disposisi yang perlu ditindaklanjuti.</p>';
                return;
            }
            let html = `<div class="space-y-4">`;
            disposisiList.forEach(d => {
                const userLevel = parseInt(currentUser.level);
                const isFinalLevel = [5, 6].includes(userLevel);
                const canForward = !isFinalLevel && d.status_tindak_lanjut !== 'Selesai' && d.status_tindak_lanjut !== 'Diteruskan';
                const forwardButton = canForward ? `<button onclick="openDisposisiModal('${d.id_surat}', '${d.id}', '${d.nomor_surat.replace(/'/g, "\\'")}')" class="text-sm bg-amber-600/50 hover:bg-amber-600/80 text-white font-medium py-1 px-3 rounded-md flex items-center space-x-2"><i data-lucide="send" class="w-4 h-4"></i><span>Disposisi Lanjut</span></button>` : '';
                const statusUpdateOptions = d.status_tindak_lanjut !== 'Selesai' && d.status_tindak_lanjut !== 'Diteruskan'
                    ? `<select onchange="updateDisposisiStatus('${d.id}', 'tindak_lanjut', this.value)" class="text-sm border rounded p-1 form-input">
                        <option class="text-black" value="Belum Diproses" ${d.status_tindak_lanjut === 'Belum Diproses' ? 'selected' : ''}>Belum Diproses</option>
                        <option class="text-black" value="Diproses" ${d.status_tindak_lanjut === 'Diproses' ? 'selected' : ''}>Diproses</option>
                        <option class="text-black" value="Selesai" ${d.status_tindak_lanjut === 'Selesai' ? 'selected' : ''}>Selesai</option>
                       </select>`
                    : `<span class="text-sm font-semibold text-gray-300">${d.status_tindak_lanjut}</span>`;
                html += `
                    <div class="glass-card p-4 border-l-4 ${d.status_baca === 'Belum Dibaca' ? 'border-red-500' : 'border-gray-500'}">
                        <div class="flex flex-wrap justify-between items-start gap-2">
                             <div>
                                <p class="font-bold text-white">${d.nomor_surat}</p>
                                <p class="text-sm text-gray-200">${d.perihal}</p>
                                <p class="text-xs text-gray-300 mt-1">Dari: <strong>${d.dari_user_nama}</strong> &bull; ${formatTanggalWaktu(d.tanggal_disposisi)}</p>
                            </div>
                            <div class="flex items-center space-x-2">${statusUpdateOptions}</div>
                        </div>
                        <div class="mt-3 p-3 bg-black/20 rounded-md">
                            <p class="text-sm text-gray-100"><strong>Instruksi:</strong> ${d.catatan || 'Tidak ada catatan.'}</p>
                        </div>
                        <div class="mt-3 flex items-center space-x-4">
                            <a href="${d.file_url}" target="_blank" class="text-sm text-amber-400 hover:underline font-medium">Lihat File Surat</a>
                            <button onclick="openRiwayatModal('${d.id_surat}', '${d.nomor_surat.replace(/'/g, "\\'")}')" class="text-sm text-cyan-400 hover:underline font-medium">Riwayat</button>
                            ${d.status_baca === 'Belum Dibaca' ? `<button onclick="updateDisposisiStatus('${d.id}', 'baca')" class="text-sm text-amber-400 hover:underline font-medium">Tandai Dibaca</button>` : ''}
                            ${forwardButton}
                        </div>
                    </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        }
        async function updateDisposisiStatus(disposisiId, statusType, value = null) {
            showLoading(true);
            try {
                const payload = { action: 'update_disposisi_status', id: disposisiId, statusType, value, userId: currentUser.id };
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    loadMyDisposisi(1); 
                    loadDashboardData(); 
                } else {
                    showCustomAlert('Gagal update status: ' + (result.message || 'Terjadi kesalahan.'), 'Kesalahan Update');
                }
            } catch (error) {
                console.error('Update status error:', error);
                showCustomAlert('Terjadi kesalahan jaringan/server: ' + error.message, 'Kesalahan Jaringan');
            } finally {
                showLoading(false);
            }
        }
        
        // --- SEARCH & PAGINATION ---
        function handleSearch(pageType) {
            if (pageType === 'surat-masuk') {
                loadSuratData('Masuk', 1);
            } else if (pageType === 'disposisi') {
                loadMyDisposisi(1);
            } else if (pageType === 'arsip') {
                loadArsipData(1);
            }
        }
        function renderPagination(pageType, container, pagination, callback) {
            const { totalItems, totalPages, currentPage } = pagination;
            if (totalPages <= 1) { container.innerHTML = ''; return; }
            const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
            const endItem = Math.min(startItem + ITEMS_PER_PAGE - 1, totalItems);
            
            let pageButtonsHtml = '';
            // Logic for showing limited page buttons
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (currentPage - 1 <= 2) {
                endPage = Math.min(5, totalPages);
            }
            if (totalPages - currentPage <= 2) {
                startPage = Math.max(1, totalPages - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                pageButtonsHtml += `<button onclick="${callback.name}(${i})" class="pagination-btn ${i === currentPage ? 'active' : ''}">${i}</button>`;
            }

            container.innerHTML = `
                <span class="text-gray-300">Menampilkan ${startItem}-${endItem} dari ${totalItems}</span>
                <div class="flex items-center gap-2">
                    <button onclick="${callback.name}(${currentPage - 1})" class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                    ${pageButtonsHtml}
                    <button onclick="${callback.name}(${currentPage + 1})" class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>
                </div>`;
        }


        // --- HISTORY ---
        async function openRiwayatModal(suratId, suratNomor) {
            const modal = document.getElementById('modal-riwayat');
            const container = document.getElementById('riwayat-timeline-container');
            document.getElementById('riwayat-surat-nomor').textContent = `No. Surat: ${suratNomor}`;
            container.innerHTML = '<p class="text-gray-200">Memuat riwayat surat...</p>';
            modal.style.display = 'flex';
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_surat_history&suratId=${suratId}`);
                if (data.status === 'success') {
                    renderRiwayat(container, data.history);
                } else {
                    container.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat riwayat.'}</p>`;
                }
            } catch (error) {
                console.error('Load History error:', error);
                container.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            }
        }
        function renderRiwayat(container, history) {
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-gray-400">Tidak ada riwayat untuk surat ini.</p>';
                return;
            }
            let html = '<div class="relative border-l-2 border-white/20 ml-3">';
            history.forEach((item) => {
                html += `
                    <div class="mb-8 ml-6">
                        <span class="absolute flex items-center justify-center w-6 h-6 bg-amber-500 rounded-full -left-3 ring-4 ring-amber-900/50">
                            <i data-lucide="check" class="w-4 h-4 text-white"></i>
                        </span>
                        <h3 class="flex items-center mb-1 text-lg font-semibold text-white">${item.actor}</h3>
                        <time class="block mb-2 text-sm font-normal leading-none text-gray-400">${formatTanggalWaktu(item.timestamp)}</time>
                        <p class="mb-2 text-base font-normal text-gray-200">${item.action}</p>
                        <p class="text-sm font-italic text-gray-300 bg-black/20 p-2 rounded-md">Catatan: ${item.detail}</p>
                    </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
            lucide.createIcons();
        }
        
        // --- DASHBOARD, ADMIN, & OTHER PAGES ---
        async function loadDashboardData() { 
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_dashboard_data&userId=${currentUser.id}`);
                if (data.status === 'success') {
                    document.getElementById('stat-masuk').textContent = data.stats.suratMasukBulanIni || 0;
                    document.getElementById('stat-unread').textContent = data.stats.inboxBelumDibaca || 0;
                    const container = document.getElementById('disposisi-list-dashboard');
                    if (data.latestDisposisi && data.latestDisposisi.length > 0) {
                         let html = '';
                         data.latestDisposisi.slice(0, 5).forEach(d => {
                            html += `
                                <div class="p-3 border-b border-white/20 hover:bg-black/10 rounded-lg">
                                    <p class="font-semibold text-white">${d.perihal}</p>
                                    <p class="text-sm text-gray-200">Disposisi dari <strong>${d.dari_user_nama}</strong>. 
                                    Status: <span class="font-medium ${d.status_baca === 'Belum Dibaca' ? 'text-red-400' : 'text-green-400'}">${d.status_baca}</span></p>
                                </div>`;
                         });
                         container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-gray-200">Tidak ada disposisi atau notifikasi terbaru.</p>';
                    }
                }
            } catch (error) { console.error('Load Dashboard error:', error); } 
            finally { showLoading(false); }
        }
        async function loadUserManagement() {
            const container = document.getElementById('user-management-content');
            container.innerHTML = '<p class="text-gray-200">Memuat daftar pengguna...</p>';
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_users&userId=${currentUser.id}`);
                if (data.status === 'success') {
                    renderUserManagementList(container, data.users);
                } else {
                    container.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat data pengguna.'}</p>`;
                }
            } catch (error) {
                console.error('Load Users error:', error);
                container.innerHTML = `<p class="text-red-400">Kesalahan Jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        function renderUserManagementList(container, users) {
             if (!users || users.length === 0) {
                container.innerHTML = '<p class="text-gray-200 text-center py-4">Tidak ada data pengguna.</p>';
                return;
            }
            let html = `
            <table class="min-w-full divide-y divide-white/20">
                <thead class="bg-black/20">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Nama</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">User ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Jabatan</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/20">`;
            users.forEach(user => {
                const statusClass = user.status === 'Aktif' ? 'bg-green-500/80' : 'bg-red-500/80';
                const toggleStatusText = user.status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleBtnClass = user.status === 'Aktif' ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-sky-600 hover:bg-sky-700';
                html += `
                    <tr class="hover:bg-black/10">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${user.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${user.userid}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${user.jabatan} (Lvl ${user.level})</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass} text-white">${user.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                           <button onclick="openUserModal('${user.id}')" class="px-3 py-1 rounded-md text-white bg-blue-600 hover:bg-blue-700 text-xs">Edit</button>
                           <button onclick="handleUserAction('${user.id}', 'reset_password')" class="px-3 py-1 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 text-xs">Reset Pass</button>
                           <button onclick="handleUserAction('${user.id}', 'toggle_status', '${user.status}')" class="px-3 py-1 rounded-md text-white ${toggleBtnClass} text-xs">${toggleStatusText}</button>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        async function openUserModal(userId = null) {
            const modal = document.getElementById('modal-user-form');
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('user-form-id').value = '';
            showMessage('user-form-message', '', false);
            if (userId) {
                document.getElementById('user-form-title').textContent = 'Edit User';
                document.getElementById('user-form-notice').classList.add('hidden');
                document.getElementById('user-form-id').value = userId;
                showLoading(true);
                try {
                    const data = await fetchWithRetry(`${GAS_API_URL}?action=get_user_details&userId=${currentUser.id}&targetUserId=${userId}`);
                    if (data.status === 'success') {
                        const user = data.user;
                        document.getElementById('user-form-nama').value = user.nama;
                        document.getElementById('user-form-userid').value = user.userid;
                        document.getElementById('user-form-wa').value = user.wa;
                        document.getElementById('user-form-email').value = user.email || '';
                        const roleValue = JSON.stringify({ jabatan: user.jabatan, level: user.level });
                        document.getElementById('user-form-jabatan-level').value = roleValue;
                    } else { throw new Error(data.message); }
                } catch (error) {
                    showCustomAlert(`Gagal memuat data user: ${error.message}`, 'Error');
                    return;
                } finally { showLoading(false); }
            } else {
                document.getElementById('user-form-title').textContent = 'Tambah User Baru';
                document.getElementById('user-form-notice').classList.remove('hidden');
            }
            modal.style.display = 'flex';
        }
        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const targetUserId = document.getElementById('user-form-id').value;
            const isEditing = !!targetUserId;
            const roleDataEl = document.getElementById('user-form-jabatan-level');
            if (!roleDataEl.value) {
                showMessage('user-form-message', 'Jabatan & Level harus dipilih.', true);
                return;
            }
            const { jabatan, level } = JSON.parse(roleDataEl.value);
            const payload = {
                action: isEditing ? 'edit_user' : 'register',
                adminUserId: currentUser.id,
                targetUserId: targetUserId,
                nama: document.getElementById('user-form-nama').value.trim(),
                userid: document.getElementById('user-form-userid').value.trim(),
                wa: document.getElementById('user-form-wa').value.trim(),
                email: document.getElementById('user-form-email').value.trim(),
                jabatan: jabatan,
                level: level,
            };
            showLoading(true);
            try {
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    document.getElementById('modal-user-form').style.display = 'none';
                    showCustomAlert(result.message, 'Berhasil');
                    loadUserManagement();
                } else {
                    showMessage('user-form-message', result.message || 'Terjadi kesalahan.', true);
                }
            } catch (error) {
                showMessage('user-form-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        function handleUserAction(targetUserId, action, currentValue) {
            if (action === 'reset_password') {
                showCustomConfirm('Anda yakin ingin mereset password user ini menjadi "password123"?', (confirmed) => {
                    if (confirmed) performUserAction(targetUserId, 'reset_password');
                });
            } else if (action === 'toggle_status') {
                const newStatus = currentValue === 'Aktif' ? 'Nonaktif' : 'Aktifkan';
                showCustomConfirm(`Anda yakin ingin mengubah status user ini menjadi "${newStatus}"?`, (confirmed) => {
                     if (confirmed) performUserAction(targetUserId, 'update_user_status', newStatus);
                });
            }
        }
        async function performUserAction(targetUserId, actionType, newValue = null) {
            showLoading(true);
            try {
                const payload = { 
                    action: actionType, 
                    adminUserId: currentUser.id, 
                    targetUserId: targetUserId 
                };
                if(actionType === 'update_user_status') payload.newStatus = newValue;
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    showCustomAlert(result.message, 'Berhasil');
                    loadUserManagement();
                } else {
                    showCustomAlert(result.message || 'Terjadi kesalahan.', 'Gagal');
                }
            } catch (error) {
                 showCustomAlert('Terjadi kesalahan jaringan atau server.', 'Error');
            } finally {
                showLoading(false);
            }
        }
        async function loadLogData() {
            const container = document.getElementById('log-content');
            container.innerHTML = '<p class="text-gray-200">Memuat log aktivitas...</p>';
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_log&userId=${currentUser.id}`);
                if (data.status === 'success') {
                    renderLogList(container, data.log);
                } else {
                    container.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat log.'}</p>`;
                }
            } catch (error) {
                console.error('Load Log error:', error);
                container.innerHTML = `<p class="text-red-400">Kesalahan Jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        function renderLogList(container, logs) {
            if (!logs || logs.length === 0) {
                container.innerHTML = '<p class="text-gray-200 text-center py-4">Tidak ada aktivitas yang tercatat.</p>';
                return;
            }
            let html = `
            <table class="min-w-full divide-y divide-white/20">
                <thead class="bg-black/20 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Waktu</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Pengguna</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Aksi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Detail</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/20">`;
            logs.forEach(log => {
                html += `
                    <tr class="hover:bg-black/10">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${formatTanggalWaktu(log.timestamp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${log.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${log.action}</td>
                        <td class="px-6 py-4 text-sm text-gray-300" style="word-break: break-all;">${log.detail}</td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        // --- ARSIP FUNCTIONS ---
        async function loadArsipData(page = 1) {
            const listContainer = document.getElementById('arsip-list');
            const paginationContainer = document.getElementById('pagination-arsip');
            const searchTerm = document.getElementById('search-arsip').value.trim();
            listContainer.innerHTML = '<p class="text-gray-200">Memuat data arsip...</p>';
            paginationContainer.innerHTML = '';
            showLoading(true);
            try {
                const url = `${GAS_API_URL}?action=get_arsip_data&userId=${currentUser.id}&page=${page}&limit=${ITEMS_PER_PAGE}&searchTerm=${encodeURIComponent(searchTerm)}`;
                const data = await fetchWithRetry(url);
                if (data.status === 'success') {
                    renderArsipList(listContainer, data.surat);
                    renderPagination('arsip', paginationContainer, data.pagination, loadArsipData);
                } else {
                    listContainer.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat data.'}</p>`;
                }
            } catch (error) {
                console.error('Load Arsip error:', error);
                listContainer.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        function renderArsipList(container, suratList) {
            if (!suratList || suratList.length === 0) {
                container.innerHTML = '<p class="text-gray-200 text-center py-4">Tidak ada data arsip yang ditemukan.</p>';
                return;
            }
            let html = `
            <table class="min-w-full divide-y divide-white/20">
                <thead class="bg-black/20">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Nomor Surat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Perihal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Pengirim</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/20">`;
            suratList.forEach(surat => {
                const statusClass = surat.status === 'Diarsipk-an' ? 'status-diarsipk-an' : 'status-sudah-disposisi';
                html += `
                    <tr class="hover:bg-black/10">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${surat.nomor_surat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.perihal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.pengirim_penerima}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-badge ${statusClass}">${surat.status.replace(/-/g, ' ')}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="${surat.file_url}" target="_blank" class="text-amber-400 hover:text-amber-300 font-medium">Lihat File</a>
                            <button onclick="openRiwayatModal('${surat.id}', '${surat.nomor_surat.replace(/'/g, "\\'")}')" class="text-cyan-400 hover:text-cyan-300 font-medium ml-3">Riwayat</button>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }


        // --- PROFILE FUNCTIONS ---
        function compressImage(file, maxWidth = 512) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    URL.revokeObjectURL(img.src);
                    resolve(dataUrl);
                };
                img.onerror = (error) => {
                    URL.revokeObjectURL(img.src);
                    reject(error);
                };
            });
        }
        function loadProfileData() {
            if (!currentUser) return;
            document.getElementById('profile-nama').value = currentUser.nama;
            document.getElementById('profile-wa').value = currentUser.wa;
            document.getElementById('profile-email').value = currentUser.email || '';
            const profilePicUrl = currentUser.profile_pic_url || `${DEFAULT_PIC}&name=${encodeURIComponent(currentUser.nama)}`;
            document.getElementById('profile-pic-display').src = profilePicUrl;
            document.getElementById('remove-pic-btn').style.display = currentUser.profile_pic_url ? 'flex' : 'none';
            document.getElementById('change-password-form').reset();
            showMessage('password-form-message', '', false);
        }
        async function handleProfileInfoUpdate(e) {
            e.preventDefault();
            const payload = {
                action: 'update_profile',
                userId: currentUser.id,
                nama: document.getElementById('profile-nama').value.trim(),
                wa: document.getElementById('profile-wa').value.trim(),
                email: document.getElementById('profile-email').value.trim(),
            };
            showLoading(true);
            try {
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('sidebar-user-name').textContent = currentUser.nama;
                    document.getElementById('user-display-name').textContent = currentUser.nama;
                    showCustomAlert('Informasi profil berhasil diperbarui.', 'Berhasil');
                } else {
                    showCustomAlert(result.message || 'Gagal memperbarui profil.', 'Error');
                }
            } catch (error) {
                showCustomAlert('Terjadi kesalahan jaringan.', 'Error');
            } finally {
                showLoading(false);
            }
        }
        async function handleChangePassword(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            if (newPassword.length < 6) {
                showMessage('password-form-message', 'Password baru minimal 6 karakter.', true);
                return;
            }
            if (newPassword !== confirmNewPassword) {
                showMessage('password-form-message', 'Konfirmasi password baru tidak cocok.', true);
                return;
            }
            const payload = {
                action: 'change_password',
                userId: currentUser.id,
                oldPassword: oldPassword,
                newPassword: newPassword,
            };
            showLoading(true);
            showMessage('password-form-message', '', false);
            try {
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    showMessage('password-form-message', 'Password berhasil diubah.', false);
                    e.target.reset();
                } else {
                    showMessage('password-form-message', result.message || 'Gagal mengubah password.', true);
                }
            } catch (error) {
                showMessage('password-form-message', 'Terjadi kesalahan jaringan.', true);
            } finally {
                showLoading(false);
            }
        }
        async function handleProfilePicChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { // 5MB limit for original file
                showCustomAlert('Ukuran file terlalu besar. Maksimal 5MB.', 'Error');
                return;
            }
            showLoading(true);
            try {
                const compressedDataUrl = await compressImage(file, 512);
                const base64File = compressedDataUrl.split(',')[1];
                const mimeType = compressedDataUrl.match(/:(.*?);/)[1];
                const payload = {
                    action: 'update_profile_picture',
                    userId: currentUser.id,
                    fileBase64: base64File,
                    fileMimeType: mimeType,
                };
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    currentUser.profile_pic_url = result.newUrl;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('sidebar-profile-pic').src = result.newUrl;
                    document.getElementById('profile-pic-display').src = result.newUrl;
                    document.getElementById('remove-pic-btn').style.display = 'flex';
                    showCustomAlert('Foto profil berhasil diubah.', 'Berhasil');
                } else {
                    showCustomAlert(result.message || 'Gagal mengubah foto.', 'Error');
                }
            } catch (error) {
                showCustomAlert('Terjadi kesalahan saat memproses gambar.', 'Error');
                console.error("Image processing error: ", error);
            } finally {
                showLoading(false);
            }
        }
        async function handleRemoveProfilePic() {
            showCustomConfirm("Anda yakin ingin menghapus foto profil Anda?", async (confirmed) => {
                if (!confirmed) return;
                showLoading(true);
                try {
                    const payload = { action: 'remove_profile_picture', userId: currentUser.id };
                    const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    if (result.status === 'success') {
                        currentUser = result.user;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        const newPicUrl = `${DEFAULT_PIC}&name=${encodeURIComponent(currentUser.nama)}`;
                        document.getElementById('sidebar-profile-pic').src = newPicUrl;
                        document.getElementById('profile-pic-display').src = newPicUrl;
                        document.getElementById('remove-pic-btn').style.display = 'none';
                        showCustomAlert('Foto profil berhasil dihapus.', 'Berhasil');
                    } else {
                        showCustomAlert(result.message || 'Gagal menghapus foto.', 'Error');
                    }
                } catch (error) {
                    showCustomAlert('Terjadi kesalahan jaringan.', 'Error');
                } finally {
                    showLoading(false);
                }
            });
        }
    </script>
</body>
</html>

