/**
 * SIMAS RSUD dr. R. Koesma - Backend Google Apps Script (V2 - Multi-level)
 *
 * This script acts as a Web App API to connect the HTML frontend
 * with Google Sheets (Database) and Google Drive (File Archive).
 * Implements a 5-level disposition hierarchy.
 */

const SCRIPT_TITLE = "SIMAS RSUD dr. R. Koesma";
const SHEET_ID = '1VMicXg9K7mkEb1Dn42YJyW4uiuRArwKXkG1GPKM6YR8'; // Ganti dengan ID Google Sheet Anda
const ROOT_FOLDER_NAME = 'ARSIP_SURAT_RSUD';

/** Sheet Names and their Columns (V2 Structure) */
const SHEET_CONFIG = {
    Setting: ['key', 'value'],
    Log: ['timestamp', 'user', 'action', 'detail'],
    User: ['id', 'userid', 'nama', 'wa', 'email', 'jabatan', 'level', 'password_hash', 'status'], // ADDED: level
    Surat: ['id', 'jenis', 'nomor_surat', 'perihal', 'tanggal', 'pengirim_penerima', 'file_url', 'status'], 
    Disposisi: ['id', 'id_surat', 'dari_user_id', 'ke_user_id', 'catatan', 'tanggal_disposisi', 'status_baca', 'status_tindak_lanjut', 'parent_disposisi_id', 'batch_id'] // ADDED: parent_disposisi_id, batch_id
};

// --- CORE WEB APP FUNCTIONS ---

function doPost(e) {
    let result = { status: 'error', message: 'Unknown request.' };
    
    try {
        const db = openDatabase();
        let data = JSON.parse(e.postData.contents);

        logActivity(db, 'SYSTEM', 'POST Request', JSON.stringify({ action: data.action, userId: data.userId || 'N/A' }));

        switch (data.action) {
            case 'login':
                result = handleLogin(db, data);
                break;
            case 'register':
                result = handleRegistration(db, data);
                break;
            case 'input_surat':
                result = handleSuratInput(db, data);
                break;
            case 'disposisi_surat':
                result = handleDisposisi(db, data);
                break;
            case 'update_disposisi_status':
                result = updateDisposisiStatus(db, data);
                break;
            case 'reset_password':
                result = handlePasswordReset(db, data);
                break;
            default:
                result.message = 'Action not recognized.';
        }
    } catch (error) {
        result.message = 'Server Error: ' + error.toString();
        logActivity(openDatabase(), 'SYSTEM', 'Error', result.message + " | Stack: " + error.stack);
    }
    
    return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
    let result = { status: 'error', message: 'Unknown request.' };

    try {
        const db = openDatabase();
        const params = e.parameter;
        const userId = params.userId || 'GUEST';

        logActivity(db, userId, 'GET Request', params.action);

        switch (params.action) {
            case 'get_surat_list':
                result = getSuratList(db, params.jenis);
                break;
            case 'get_dashboard_data':
                result = getDashboardData(db, userId);
                break;
            case 'get_my_disposisi':
                result = getMyDisposisi(db, userId);
                break;
            case 'get_users':
                result = getAllUsers(db, userId);
                break;
            case 'get_log':
                result = getLogData(db, userId);
                break;
            case 'get_arsip_link':
                result = getArsipLink(userId);
                break;
            default:
                result.message = 'GET Action not recognized.';
        }
    } catch (error) {
        result.message = 'Server Error: ' + error.toString();
        logActivity(openDatabase(), 'SYSTEM', 'Error', result.message + " | Stack: " + error.stack);
    }

    return ContentService.createTextOutput(JSON.stringify(result))
        .setMimeType(ContentService.MimeType.JSON);
}

// --- DATABASE & INITIALIZATION FUNCTIONS ---

function openDatabase() {
    return SpreadsheetApp.openById(SHEET_ID);
}

function initializeDatabase(ss) {
    let statusMessage = "Sheets checked: ";
    try {
        for (const sheetName in SHEET_CONFIG) {
            let sheet = ss.getSheetByName(sheetName);
            if (!sheet) {
                sheet = ss.insertSheet(sheetName);
                sheet.getRange(1, 1, 1, SHEET_CONFIG[sheetName].length).setValues([SHEET_CONFIG[sheetName]]);
                sheet.setFrozenRows(1);
                statusMessage += `${sheetName} (Created), `;
            } else {
                 statusMessage += `${sheetName} (Exists), `;
            }
        }
        logActivity(ss, 'SYSTEM', 'Database Init', statusMessage);
        return { status: 'success', message: 'Database initialization complete.', details: statusMessage };
    } catch (e) {
        return { status: 'error', message: 'Database initialization failed: ' + e.toString() };
    }
}

function getRootFolder() {
    let folders = DriveApp.getFoldersByName(ROOT_FOLDER_NAME);
    if (folders.hasNext()) return folders.next();
    logActivity(openDatabase(), 'SYSTEM', 'Drive Init', 'Root folder created: ' + ROOT_FOLDER_NAME);
    return DriveApp.createFolder(ROOT_FOLDER_NAME);
}

function getArsipLink(userId) {
    try {
        const rootFolder = getRootFolder();
        logActivity(openDatabase(), userId, 'Get Arsip Link', 'User viewed Drive link.');
        return { status: 'success', link: rootFolder.getUrl() };
    } catch (e) {
        return { status: 'error', message: 'Failed to get Drive link: ' + e.toString() };
    }
}

// --- HELPER FUNCTIONS ---

function findUserByLevel(ss, level) {
    const sheet = ss.getSheetByName('User');
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const levelIndex = headers.indexOf('level');
    
    for (let i = 1; i < rows.length; i++) {
        if (rows[i][levelIndex] == level) {
            return rowToObject(headers, rows[i]);
        }
    }
    return null;
}

function getUserById(ss, id) {
    const sheet = ss.getSheetByName('User');
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const idIndex = headers.indexOf('id');
    
    for (let i = 1; i < rows.length; i++) {
        if (rows[i][idIndex] === id) {
            return rowToObject(headers, rows[i]);
        }
    }
    return null;
}

function getSuratById(ss, id) {
    const sheet = ss.getSheetByName('Surat');
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const idIndex = headers.indexOf('id');
    
    for (let i = 1; i < rows.length; i++) {
        if (rows[i][idIndex] === id) {
            return rowToObject(headers, rows[i]);
        }
    }
    return null;
}


// --- AUTHENTICATION & USER MANAGEMENT ---

function handleLogin(ss, data) {
    const sheet = ss.getSheetByName('User');
    const rows = sheet.getDataRange().getValues();
    const headers = rows.shift();

    for (const row of rows) {
        const user = rowToObject(headers, row);
        if (user.userid === data.userid && user.password_hash === data.password) {
            if (user.status !== 'Aktif') {
                 logActivity(ss, user.id, 'Login Failed', 'Account is inactive.');
                 return { status: 'error', message: 'Akun Anda nonaktif. Hubungi Admin.' };
            }
            logActivity(ss, user.id, 'Login Success', `User ${user.nama} logged in.`);
            delete user.password_hash;
            return { status: 'success', message: 'Login successful.', user: user };
        }
    }
    logActivity(ss, data.userid || 'Unknown', 'Login Failed', 'Invalid credentials.');
    return { status: 'error', message: 'User ID atau Password salah.' };
}

function handleRegistration(ss, data) {
    const sheet = ss.getSheetByName('User');
    const userid = data.userid;

    const userIdColumn = sheet.getRange('B:B').getValues().flat();
    if (userIdColumn.includes(userid)) {
        return { status: 'error', message: 'User ID sudah terdaftar.' };
    }

    const newId = Utilities.getUuid();
    sheet.appendRow([
        newId, 
        userid,
        data.nama, 
        data.wa, 
        data.email, 
        data.jabatan, 
        data.level,
        data.password, // Storing plain password
        'Aktif'
    ]);
    
    logActivity(ss, newId, 'Registration Success', `New user ${data.nama} registered.`);
    return { status: 'success', message: 'Pendaftaran berhasil.' };
}

function handlePasswordReset(ss, data) {
    const adminUser = getUserById(ss, data.adminUserId);
    if (!adminUser || adminUser.jabatan !== 'Super Admin') {
        return { status: 'error', message: 'Unauthorized. Only Super Admin can reset passwords.' };
    }

    const targetSheet = ss.getSheetByName('User');
    const rows = targetSheet.getDataRange().getValues();
    const headers = rows[0];
    const idIndex = headers.indexOf('id');
    const hashIndex = headers.indexOf('password_hash');
    const targetRow = rows.findIndex(row => row[idIndex] === data.targetUserId);

    if (targetRow === -1) return { status: 'error', message: 'Target user not found.' };

    targetSheet.getRange(targetRow + 1, hashIndex + 1).setValue('password123');
    
    logActivity(ss, data.adminUserId, 'Password Reset', `User ID ${data.targetUserId} password reset.`);
    return { status: 'success', message: 'Password berhasil direset menjadi "password123".' };
}

function getAllUsers(ss, userId) {
    const userSheet = ss.getSheetByName('User');
    const rows = userSheet.getDataRange().getValues();
    const headers = rows.shift();
    const users = rows.map(row => {
        const user = rowToObject(headers, row);
        delete user.password_hash;
        return user;
    });
    return { status: 'success', users: users };
}

// --- SURAT & ARSIP MANAGEMENT ---

function getMonthlyFolder(date) {
    const rootFolder = getRootFolder();
    const year = date.getFullYear().toString();
    const monthName = Utilities.formatDate(date, Session.getScriptTimeZone(), "MM_MMMM");
    let yearFolder = getOrCreateFolder(rootFolder, year);
    return getOrCreateFolder(yearFolder, monthName);
}

function getOrCreateFolder(parent, name) {
    let folders = parent.getFoldersByName(name);
    if (folders.hasNext()) return folders.next();
    return parent.createFolder(name);
}

function handleSuratInput(ss, data) {
    const suratSheet = ss.getSheetByName('Surat');
    const user = getUserById(ss, data.userId);

    if (!user) return { status: 'error', message: 'User not authenticated.' };
    if (user.jabatan !== 'Admin TU' && user.jabatan !== 'Super Admin') {
        return { status: 'error', message: 'Hanya Admin TU atau Super Admin yang dapat mengupload surat masuk.' };
    }

    try {
        const fileBlob = Utilities.newBlob(Utilities.base64Decode(data.fileBase64), data.fileMimeType, data.fileName);
        const targetFolder = getMonthlyFolder(new Date(data.tanggal));
        const newFile = targetFolder.createFile(fileBlob);
        const fileUrl = newFile.getUrl();

        const newSuratId = Utilities.getUuid();
        suratSheet.appendRow([
            newSuratId, 'Masuk', data.nomor, data.perihal, data.tanggal,
            data.pengirim_penerima, fileUrl, 'Sudah Disposisi'
        ]);

        const direktur = findUserByLevel(ss, 1);
        if (!direktur) throw new Error("Tidak ditemukan user dengan Level 1 (Direktur).");

        const disposisiSheet = ss.getSheetByName('Disposisi');
        disposisiSheet.appendRow([
            Utilities.getUuid(), newSuratId, user.id, direktur.id,
            "Surat masuk baru untuk ditindaklanjuti.", new Date(), 'Belum Dibaca',
            'Belum Diproses', null, null
        ]);

        logActivity(ss, user.id, 'Input Surat & Auto-Disposisi', `${data.nomor} -> ke ${direktur.nama}`);
        return { status: 'success', message: 'Surat berhasil diarsip dan otomatis didisposisikan ke Direktur.', fileUrl: fileUrl };

    } catch (e) {
        logActivity(ss, user.id, 'Input Surat Failed', e.toString());
        return { status: 'error', message: 'Gagal menyimpan surat: ' + e.toString() };
    }
}

function getSuratList(ss, jenis) {
    const suratSheet = ss.getSheetByName('Surat');
    const rows = suratSheet.getDataRange().getValues();
    const headers = rows.shift();
    
    const suratList = rows
        .map(row => rowToObject(headers, row))
        .filter(surat => surat.jenis === jenis)
        .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

    return { status: 'success', surat: suratList };
}


// --- DISPOSISI & NOTIFIKASI ---

function handleDisposisi(ss, data) {
    const disposisiSheet = ss.getSheetByName('Disposisi');
    const dariUser = getUserById(ss, data.dari_user_id);
    if (!dariUser) return { status: 'error', message: 'User pengirim tidak valid.' };
    
    const recipients = data.ke_user_ids || [];
    if (recipients.length === 0) return { status: 'error', message: 'Penerima disposisi belum dipilih.' };

    try {
        const timestamp = new Date();
        const batchId = Utilities.getUuid();

        recipients.forEach(ke_user_id => {
            const keUser = getUserById(ss, ke_user_id);
            if (keUser) {
                disposisiSheet.appendRow([
                    Utilities.getUuid(), data.id_surat, data.dari_user_id, ke_user_id, 
                    data.catatan, timestamp, 'Belum Dibaca', 'Belum Diproses',
                    data.parent_disposisi_id || null, batchId
                ]);
                logActivity(ss, dariUser.id, 'Disposisi Success', `Disposisi ke ${keUser.nama} (Batch: ${batchId})`);
            } else {
                logActivity(ss, dariUser.id, 'Disposisi Warning', `User ID penerima ${ke_user_id} tidak ditemukan.`);
            }
        });

        if (data.parent_disposisi_id) {
            updateDisposisiStatus(ss, { 
                id: data.parent_disposisi_id, statusType: 'tindak_lanjut', 
                value: 'Diteruskan', userId: data.dari_user_id 
            });
        }
        
        return { status: 'success', message: `Disposisi berhasil dikirim ke ${recipients.length} penerima.` };
    } catch (e) {
        logActivity(ss, data.dari_user_id, 'Disposisi Failed', e.toString() + " | Stack: " + e.stack);
        return { status: 'error', message: 'Gagal melakukan disposisi: ' + e.toString() };
    }
}

function updateDisposisiStatus(ss, data) {
    const sheet = ss.getSheetByName('Disposisi');
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const idIndex = headers.indexOf('id');
    const statusColumnName = `status_${data.statusType}`;
    const statusIndex = headers.indexOf(statusColumnName);

    if (statusIndex === -1) return { status: 'error', message: `Kolom status tidak ditemukan.` };

    const newStatus = data.statusType === 'baca' ? 'Sudah Dibaca' : data.value;
    const targetRowIndex = rows.findIndex(row => row[idIndex] === data.id);

    if (targetRowIndex === -1) return { status: 'error', message: 'Disposisi ID tidak ditemukan.' };
    
    sheet.getRange(targetRowIndex + 1, statusIndex + 1).setValue(newStatus);
    logActivity(ss, data.userId, `Update Disposisi`, `ID ${data.id} -> ${statusColumnName} = ${newStatus}.`);
    return { status: 'success', message: `Status berhasil diubah.` };
}

function getMyDisposisi(ss, userId) {
    const dispoRows = ss.getSheetByName('Disposisi').getDataRange().getValues();
    const dispoHeaders = dispoRows.shift();
    const suratMap = createMapFromSheet(ss, 'Surat', 'id');
    const userMap = createMapFromSheet(ss, 'User', 'id', ['nama', 'wa']);

    const myDisposisi = dispoRows
        .map(row => rowToObject(dispoHeaders, row))
        .filter(d => d.ke_user_id === userId)
        .map(d => {
            const surat = suratMap[d.id_surat] || {};
            const dariUser = userMap[d.dari_user_id] || {};
            return {
                id: d.id, // ID disposisi, bukan surat
                id_surat: d.id_surat,
                nomor_surat: surat.nomor_surat,
                perihal: surat.perihal,
                file_url: surat.file_url,
                dari_user_nama: dariUser.nama || 'N/A',
                tanggal_disposisi: d.tanggal_disposisi,
                status_baca: d.status_baca,
                status_tindak_lanjut: d.status_tindak_lanjut,
                catatan: d.catatan
            };
        })
        .sort((a, b) => new Date(b.tanggal_disposisi) - new Date(a.tanggal_disposisi));

    logActivity(ss, userId, 'Get My Disposisi', `Fetched ${myDisposisi.length} disposisi.`);
    return { status: 'success', disposisi: myDisposisi };
}

// --- DASHBOARD DATA ---

function getDashboardData(ss, userId) {
    const allSurat = ss.getSheetByName('Surat').getDataRange().getValues();
    allSurat.shift(); // remove header

    const allDisposisi = ss.getSheetByName('Disposisi').getDataRange().getValues();
    const dispoHeaders = allDisposisi.shift();

    const today = new Date();
    const thisMonth = today.getMonth();
    const thisYear = today.getFullYear();
    
    const suratMasukBulanIni = allSurat.filter(s => {
        const sDate = new Date(s[4]); // tanggal column
        return s[1] === 'Masuk' && sDate.getMonth() === thisMonth && sDate.getFullYear() === thisYear;
    }).length;

    const disposisiObjects = allDisposisi.map(r => rowToObject(dispoHeaders, r));

    const belumDidisposisi = 0; // Logic changed, Admin TU doesn't see this.
    
    const belumDitindaklanjuti = disposisiObjects.filter(d => 
        d.ke_user_id === userId && 
        d.status_tindak_lanjut !== 'Selesai' && d.status_tindak_lanjut !== 'Diteruskan'
    ).length;
    
    const latestDisposisi = getMyDisposisi(ss, userId).disposisi.slice(0, 5);

    return {
        status: 'success',
        stats: { suratMasukBulanIni, belumDidisposisi, belumDitindaklanjuti },
        latestDisposisi: latestDisposisi
    };
}

// --- LOGGING & UTILITY ---

function logActivity(ss, userId, action, detail) {
    try {
        const logSheet = ss.getSheetByName('Log');
        if (!logSheet) { Logger.log('FATAL: Log sheet does not exist.'); return; }
        
        const user = getUserById(ss, userId);
        const userName = user ? `${user.nama} (${user.jabatan})` : userId;

        logSheet.appendRow([new Date(), userName, action, detail]);
    } catch (e) {
        Logger.log('FATAL: Could not write to Log sheet: ' + e.toString());
    }
}

function getLogData(ss, userId) {
    const adminUser = getUserById(ss, userId);
    if (!adminUser || adminUser.jabatan !== 'Super Admin') {
        return { status: 'error', message: 'Unauthorized. Only Super Admin can view logs.' };
    }
    
    const logSheet = ss.getSheetByName('Log');
    const rows = logSheet.getDataRange().getValues();
    const headers = rows.shift();
    const logs = rows.map(row => rowToObject(headers, row));
    
    return { status: 'success', log: logs };
}

function rowToObject(headers, row) {
    const obj = {};
    headers.forEach((header, index) => { obj[header] = row[index]; });
    return obj;
}

function createMapFromSheet(ss, sheetName, keyCol, valCols = null) {
    const sheet = ss.getSheetByName(sheetName);
    const rows = sheet.getDataRange().getValues();
    const headers = rows.shift();
    const map = {};
    const keyIndex = headers.indexOf(keyCol);
    if (keyIndex === -1) return map;

    rows.forEach(row => {
        const key = row[keyIndex];
        if (valCols) {
             const limitedObj = {};
             valCols.forEach(col => {
                const colIndex = headers.indexOf(col);
                if(colIndex !== -1) limitedObj[col] = row[colIndex]
             });
             map[key] = limitedObj;
        } else {
             map[key] = rowToObject(headers, row);
        }
    });
    return map;
}

/**
 * Initial setup function. Run once from Apps Script Editor.
 */
function initialSetup() {
    const ss = openDatabase();
    initializeDatabase(ss); // Creates sheets if they don't exist
    getRootFolder();
    
    // Add new columns if they don't exist
    const userSheet = ss.getSheetByName('User');
    const userHeaders = userSheet.getRange(1, 1, 1, userSheet.getLastColumn()).getValues()[0];
    if (!userHeaders.includes('level')) {
        userSheet.getRange(1, userHeaders.length + 1).setValue('level');
        logActivity(ss, 'SYSTEM', 'Sheet Update', 'Added "level" to User sheet.');
    }
    
    const dispoSheet = ss.getSheetByName('Disposisi');
    const dispoHeaders = dispoSheet.getRange(1, 1, 1, dispoSheet.getLastColumn()).getValues()[0];
    if (!dispoHeaders.includes('parent_disposisi_id')) {
        dispoSheet.getRange(1, dispoHeaders.length + 1).setValue('parent_disposisi_id');
        logActivity(ss, 'SYSTEM', 'Sheet Update', 'Added "parent_disposisi_id" to Disposisi sheet.');
    }
    if (!dispoHeaders.includes('batch_id')) {
        // After adding parent_disposisi_id, the last column index increases by 1
        const newLastCol = dispoSheet.getLastColumn();
        dispoSheet.getRange(1, newLastCol + 1).setValue('batch_id');
        logActivity(ss, 'SYSTEM', 'Sheet Update', 'Added "batch_id" to Disposisi sheet.');
    }

    Logger.log('Setup Complete. Please re-deploy the Web App with a new version.');
}

