<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Surat RSUD dr. R. Koesma</title>
    <link rel="icon" type="image/png" href="https://github.com/koesmasurat/1/blob/main/new%20logo%20rsud%202025%20kecil.png?raw=true">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --main-color: #f59e0b; /* Amber 500 */ 
            --main-color-light: #fcd34d; /* Amber 300 */
        }
        
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        body { 
            font-family: 'Inter', sans-serif; 
            background-image: url('https://images.unsplash.com/photo-1557682250-33bd709cbe85?q=80&w=2670&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }
        .active-link { 
            border-left: 4px solid var(--main-color-light); 
            background-color: rgba(255, 255, 255, 0.15); 
            font-weight: 600; 
            color: white;
        }
        
        .glass-card {
            background: rgba(20, 10, 0, 0.6); /* Darker glass for better contrast */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }

        .form-input {
            background: rgba(0,0,0,0.2) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            color: white !important;
        }
        .form-input::placeholder { color: rgba(255,255,255,0.5) !important; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); z-index: 50; justify-content: center; align-items: center; }
        .modal { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Main App Container -->
    <div id="app" class="flex">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out w-64 glass-card z-40 m-2 rounded-2xl flex-shrink-0 flex flex-col h-[calc(100vh-1rem)]">
            <div class="p-6 border-b border-white/20 text-center flex-shrink-0">
                <img src="https://github.com/koesmasurat/1/blob/main/new%20logo%20rsud%202025%20kecil.png?raw=true" alt="Logo RSUD" class="w-16 h-16 mx-auto mb-2">
                <h1 class="text-xl font-bold text-white">SIMAS RSUD</h1>
                <p class="text-sm text-gray-200">dr. R. Koesma</p>
            </div>
            <nav class="mt-6 flex-grow overflow-y-auto">
                <a href="#dashboard" onclick="showPage('dashboard')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span>
                </a>
                <a href="#surat-masuk" id="nav-surat-masuk" onclick="showPage('surat-masuk')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="mail-check" class="w-5 h-5"></i><span>Surat Masuk</span>
                </a>
                <a href="#surat-keluar" id="nav-surat-keluar" onclick="showPage('surat-keluar')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="send" class="w-5 h-5"></i><span>Surat Keluar</span>
                </a>
                <a href="#disposisi" onclick="showPage('disposisi')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="layers-3" class="w-5 h-5"></i><span>Inbox Disposisi</span>
                </a>
                <a href="#arsip" onclick="showPage('arsip')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="archive" class="w-5 h-5"></i><span>Arsip Dokumen</span>
                </a>
                <a href="#users" onclick="showPage('users')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="users" class="w-5 h-5"></i><span>Manajemen User</span>
                </a>
                <a href="#log" onclick="showPage('log')" class="nav-link block px-6 py-3 text-gray-100 hover:bg-white/10 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="file-text" class="w-5 h-5"></i><span>Log Aktivitas</span>
                </a>
            </nav>
            <div class="p-6 w-full border-t border-white/20 flex-shrink-0">
                <button onclick="logout()" class="w-full text-left flex items-center space-x-3 text-red-400 hover:text-red-300 transition duration-150">
                    <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
                </button>
            </div>
        </div>
        
        <!-- Content Area -->
        <div id="content-area" class="flex-1 transition-all duration-300 p-2 md:p-4 min-w-0">
            <button id="menu-toggle" class="md:hidden p-2 rounded-full glass-card mb-4 fixed top-4 right-4 z-50">
                <i data-lucide="menu" class="w-6 h-6 text-white"></i>
            </button>

            <!-- Pages Container -->
            <div id="pages-container">
                <!-- Login Page -->
                <div id="login-page" class="page max-w-md mx-auto mt-20 p-8 glass-card">
                    <h2 class="text-2xl font-bold mb-6 text-center text-white">Login SIMAS RSUD</h2>
                    <p class="text-sm text-center text-red-400 mb-4" id="login-error-message"></p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-userid" class="block text-sm font-medium text-gray-200">User ID</label>
                            <input type="text" id="login-userid" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400 sm:text-sm form-input" placeholder="Masukkan User ID Anda">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-200">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400 sm:text-sm form-input">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition duration-150">
                            Masuk
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-300">
                        Belum punya akun? <a href="#" onclick="showPage('register')" class="font-medium text-amber-400 hover:text-amber-300">Daftar Sekarang</a>
                    </p>
                </div>
                
                <!-- Register Page -->
                <div id="register-page" class="page max-w-lg mx-auto mt-10 p-8 glass-card hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center text-white">Pendaftaran Akun Baru</h2>
                    <p class="text-sm text-center text-red-400 mb-4" id="register-error-message"></p>
                    <form id="register-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                                <label for="reg-nama" class="block text-sm font-medium text-gray-200">Nama Lengkap</label>
                                <input type="text" id="reg-nama" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="reg-userid" class="block text-sm font-medium text-gray-200">User ID (untuk login)</label>
                                <input type="text" id="reg-userid" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="reg-jabatan-level" class="block text-sm font-medium text-gray-200">Jabatan & Level</label>
                                <select id="reg-jabatan-level" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                                    <option value="">Pilih Jabatan</option>
                                    <option value='{"jabatan": "Super Admin", "level": 0}'>Super Admin (Level 0)</option>
                                    <option value='{"jabatan": "Admin TU", "level": 0}'>Admin TU (Level 0)</option>
                                    <option value='{"jabatan": "Direktur", "level": 1}'>Direktur (Level 1)</option>
                                    <option value='{"jabatan": "Wadir Adminkeu", "level": 2}'>Wadir Adminkeu (Level 2)</option>
                                    <option value='{"jabatan": "Kabag", "level": 3}'>Kabag (Level 3)</option>
                                    <option value='{"jabatan": "Kabid", "level": 3}'>Kabid (Level 3)</option>
                                    <option value='{"jabatan": "JFT", "level": 4}'>JFT (Level 4)</option>
                                    <option value='{"jabatan": "Staf", "level": 5}'>Staf (Level 5)</option>
                                </select>
                            </div>
                            <div>
                                <label for="reg-wa" class="block text-sm font-medium text-gray-200">Nomor WA</label>
                                <input type="text" id="reg-wa" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm" placeholder="6281xxxx">
                            </div>
                             <div class="md:col-span-2">
                                <label for="reg-email" class="block text-sm font-medium text-gray-200">Email (Opsional)</label>
                                <input type="email" id="reg-email" class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="reg-password" class="block text-sm font-medium text-gray-200">Password</label>
                            <input type="password" id="reg-password" required class="mt-1 block w-full px-3 py-2 form-input rounded-md shadow-sm">
                        </div>
                        <button type="submit" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700">
                            Daftar
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-300">
                        Sudah punya akun? <a href="#" onclick="showPage('login')" class="font-medium text-amber-400 hover:text-amber-300">Login</a>
                    </p>
                </div>

                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-2">Dashboard</h2>
                    <p class="text-md text-gray-200 mb-6">Selamat datang, <span id="user-display-name" class="font-semibold"></span>! Jabatan: <span id="user-display-jabatan" class="font-semibold"></span></p>
                    <div id="dashboard-content">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="p-6 glass-card border-t-4 border-sky-400">
                                <p class="text-sm font-medium text-gray-200">Surat Masuk Bulan Ini</p>
                                <p class="text-3xl font-bold mt-1" id="stat-masuk">0</p>
                            </div>
                            <div class="p-6 glass-card border-t-4 border-amber-400">
                                <p class="text-sm font-medium text-gray-200">Surat Belum Didisposisi</p>
                                <p class="text-3xl font-bold mt-1" id="stat-undisposed">0</p>
                            </div>
                            <div class="p-6 glass-card border-t-4 border-rose-500">
                                <p class="text-sm font-medium text-gray-200">Disposisi Belum Selesai</p>
                                <p class="text-3xl font-bold mt-1" id="stat-unfollowed">0</p>
                            </div>
                        </div>

                        <!-- Disposisi List -->
                        <div class="p-6 glass-card">
                            <h3 class="text-xl font-semibold mb-4">Disposisi Terbaru untuk Anda</h3>
                            <div id="disposisi-list-dashboard">
                                <p class="text-gray-200">Memuat data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Surat Masuk Page -->
                <div id="surat-masuk-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Daftar Surat Masuk</h2>
                     <button id="btn-tambah-surat" onclick="openTambahSuratModal()" class="mb-6 bg-amber-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-amber-700 transition duration-150 flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Tambah Surat Masuk
                    </button>
                    <div class="p-6 glass-card">
                        <div class="mb-4">
                            <input type="text" id="search-surat" onkeyup="filterSurat('surat-masuk-list', this.value)" placeholder="Cari: Nomor/Perihal/Pengirim" class="w-full px-3 py-2 form-input rounded-md">
                        </div>
                        <div id="surat-masuk-list" class="overflow-x-auto">
                            <p class="text-gray-200">Data surat masuk akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>

                <!-- Surat Keluar Page -->
                <div id="surat-keluar-page" class="page hidden text-white">
                     <h2 class="text-3xl font-bold mb-6">Daftar Surat Keluar</h2>
                </div>

                <!-- Disposisi Saya Page -->
                <div id="disposisi-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Inbox Disposisi</h2>
                    <div class="p-6 glass-card">
                        <div id="my-disposisi-list" class="overflow-x-auto">
                            <p class="text-gray-200">Daftar disposisi untuk Anda akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>

                <!-- Arsip Page -->
                <div id="arsip-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Arsip Dokumen</h2>
                    <p class="text-gray-200 mb-6">Lihat semua arsip surat yang tersimpan di Google Drive.</p>
                    <div class="p-6 glass-card">
                        <div id="arsip-list">
                            <p class="text-gray-200">Data arsip akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>
                
                <!-- User Management Page -->
                <div id="users-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Manajemen User</h2>
                    <div id="user-management-content" class="p-6 glass-card">
                        <p class="text-gray-200">Daftar pengguna akan dimuat di sini...</p>
                    </div>
                </div>

                <!-- Log Page -->
                <div id="log-page" class="page hidden text-white">
                    <h2 class="text-3xl font-bold mb-6">Log Aktivitas</h2>
                    <div id="log-content" class="p-6 glass-card">
                        <p class="text-gray-200">Log sistem akan dimuat di sini...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Tambah Surat -->
    <div id="modal-tambah-surat" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-5 w-full max-w-2xl glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">Input Surat Masuk</h3>
            <form id="form-surat">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Nomor Surat</label>
                    <input type="text" id="surat-nomor" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Perihal</label>
                    <input type="text" id="surat-perihal" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Tanggal Surat</label>
                    <input type="date" id="surat-tanggal" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200" id="label-pengirim">Pengirim</label>
                    <input type="text" id="surat-pengirim" required class="mt-1 block w-full px-3 py-2 rounded-md form-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Upload File (PDF/DOCX/JPG/PNG)</label>
                    <input type="file" id="surat-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required class="mt-1 block w-full text-gray-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100">
                </div>
                <div id="surat-form-message" class="text-sm text-red-400 mb-4"></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="document.getElementById('modal-tambah-surat').style.display='none';" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">Simpan & Kirim ke Direktur</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Disposisi -->
    <div id="modal-disposisi" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-5 w-full max-w-xl glass-card">
            <h3 class="text-xl font-bold mb-4 text-white">Disposisi Lanjut Surat</h3>
            <p class="text-sm text-amber-300 mb-4" id="dispo-surat-nomor"></p>
            <form id="form-disposisi">
                <input type="hidden" id="dispo-surat-id">
                <input type="hidden" id="dispo-parent-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Pilih Penerima Disposisi</label>
                    <div id="dispo-penerima-list" class="mt-2 max-h-48 overflow-y-auto space-y-2 p-3 bg-black/20 rounded-md">
                        <!-- Checkboxes filled by JS -->
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-200">Instruksi/Catatan</label>
                    <textarea id="dispo-catatan" rows="3" class="mt-1 block w-full px-3 py-2 rounded-md form-input"></textarea>
                </div>
                <div id="dispo-form-message" class="text-sm text-red-400 mb-4"></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="document.getElementById('modal-disposisi').style.display='none';" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">Kirim Disposisi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Custom Alert/Confirm -->
    <div id="modal-custom" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-6 w-full max-w-sm glass-card">
            <h3 id="custom-modal-title" class="text-lg font-bold mb-3 text-white">Notifikasi</h3>
            <p id="custom-modal-message" class="text-sm text-gray-200 mb-6"></p>
            <div id="custom-modal-actions" class="flex justify-end space-x-2">
                <!-- Action buttons inserted by JS -->
            </div>
        </div>
    </div>

    <!-- MODAL: Riwayat Surat -->
    <div id="modal-riwayat" class="modal fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="relative p-6 w-full max-w-2xl glass-card">
            <h3 class="text-xl font-bold text-white">Riwayat Surat</h3>
            <p id="riwayat-surat-nomor" class="text-sm text-amber-300 mb-6"></p>
            
            <div id="riwayat-timeline-container" class="mt-4 max-h-[60vh] overflow-y-auto pr-4">
                <!-- Timeline will be rendered here by JS -->
            </div>

            <div class="flex justify-end mt-6">
                <button onclick="document.getElementById('modal-riwayat').style.display='none'" class="px-4 py-2 bg-gray-500/50 text-white rounded-md hover:bg-gray-500/70">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // *** PENTING: GANTI URL INI dengan URL Web App Google Apps Script Anda yang sudah di-deploy. ***
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwQvV3PoztdzPD4-eYznz_WKtUlNDRfLeyKPXKfxzqeLWhhdpyIa6QSFlXhMfpCuoU/exec'; 
        
        let currentUser = null;
        let allUsers = [];
        let confirmCallback = null;

        // --- UTILITY FUNCTIONS ---
        
        function showMessage(elementId, message, isError = true) {
            const el = document.getElementById(elementId);
            if(el) {
                el.textContent = message;
                el.className = `text-sm mb-4 ${isError ? 'text-red-400' : 'text-green-400'}`;
                el.classList.toggle('hidden', !message);
            }
        }
        
        function showCustomAlert(message, title = 'Notifikasi') {
            const modal = document.getElementById('modal-custom');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').textContent = message;
            
            const actions = document.getElementById('custom-modal-actions');
            actions.innerHTML = `<button onclick="document.getElementById('modal-custom').style.display='none';" class="px-4 py-2 bg-amber-600 text-white rounded-md hover:bg-amber-700">OK</button>`;
            modal.style.display = 'flex';
        }
        
        function showCustomConfirm(message, callback) {
            const modal = document.getElementById('modal-custom');
            document.getElementById('custom-modal-title').textContent = 'Konfirmasi Tindakan';
            document.getElementById('custom-modal-message').textContent = message;
            confirmCallback = callback;

            const actions = document.getElementById('custom-modal-actions');
            actions.innerHTML = `
                <button id="btn-cancel" class="px-4 py-2 bg-gray-500/50 rounded-md hover:bg-gray-500/70 text-white">Batal</button>
                <button id="btn-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Ya, Lanjutkan</button>
            `;
            
            document.getElementById('btn-cancel').onclick = () => {
                modal.style.display = 'none';
                if (confirmCallback) confirmCallback(false);
            };
            document.getElementById('btn-confirm').onclick = () => {
                modal.style.display = 'none';
                if (confirmCallback) confirmCallback(true);
            };

            modal.style.display = 'flex';
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }
        
        async function fetchWithRetry(url, options = {}, retries = 3) {
            let attempt = 0;
            while (attempt < retries) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const text = await response.text();
                    try { return JSON.parse(text); } 
                    catch (e) { console.error("Failed to parse JSON:", text); throw new Error("Received non-JSON response from server."); }
                } catch (error) {
                    attempt++;
                    console.warn(`Fetch attempt ${attempt} failed: ${error.message}. Retrying...`);
                    if (attempt >= retries) throw error; 
                    await new Promise(res => setTimeout(res, 1000 * attempt));
                }
            }
        }

        // --- AUTHENTICATION & UI LOGIC ---

        function updateUIVisibility() {
            const isAdminTU = currentUser && (currentUser.jabatan === 'Admin TU' || currentUser.jabatan === 'Super Admin');
            document.getElementById('btn-tambah-surat').style.display = isAdminTU ? 'flex' : 'none';
            document.getElementById('nav-surat-masuk').style.display = isAdminTU ? 'flex' : 'none';
            document.getElementById('nav-surat-keluar').style.display = 'none';
        }

        function checkLoginStatus() {
            const userData = localStorage.getItem('currentUser');
            const sidebarEl = document.getElementById('sidebar');

            if (userData) {
                currentUser = JSON.parse(userData);
                document.getElementById('user-display-name').textContent = currentUser.nama;
                document.getElementById('user-display-jabatan').textContent = `${currentUser.jabatan} (Level ${currentUser.level})`;
                
                sidebarEl.classList.remove('hidden');
                updateUIVisibility();
                const initialHash = window.location.hash.substring(1) || 'dashboard';
                showPage(initialHash);
            } else {
                currentUser = null;
                sidebarEl.classList.add('hidden');
                showPage('login');
            }
            lucide.createIcons(); 
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');

            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link'));
                const activeLink = document.querySelector(`a[href="#${pageId}"]`);
                if (activeLink) activeLink.classList.add('active-link');

                if (currentUser) {
                    window.location.hash = pageId;
                    switch (pageId) {
                        case 'dashboard': loadDashboardData(); break;
                        case 'surat-masuk': loadSuratData('Masuk'); break;
                        case 'disposisi': loadMyDisposisi(); break;
                        case 'users': loadUserManagement(); break;
                        case 'log': loadLogData(); break;
                        case 'arsip': loadArsipData(); break;
                    }
                }
            } else if (pageId === 'login' || pageId === 'register') {
                document.getElementById(pageId + '-page').classList.remove('hidden');
                window.location.hash = '';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            window.location.href = window.location.pathname;
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('form-surat').addEventListener('submit', handleSuratSubmit);
            document.getElementById('form-disposisi').addEventListener('submit', handleDisposisiSubmit);
        });

        // --- API & DATA HANDLING FUNCTIONS ---

        async function handleLogin(e) {
            e.preventDefault();
            const userid = document.getElementById('login-userid').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!GAS_API_URL.startsWith('https://') || GAS_API_URL.includes('AKfycbw...')) {
                showCustomAlert('ERROR: Harap ganti variabel GAS_API_URL di dalam kode HTML.', 'Kesalahan Konfigurasi');
                return;
            }

            showLoading(true);
            try {
                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', userid, password }),
                });

                if (result.status === 'success') {
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    window.location.reload();
                } else {
                    showMessage('login-error-message', result.message || 'Login gagal.', true);
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('login-error-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const nama = document.getElementById('reg-nama').value.trim();
            const userid = document.getElementById('reg-userid').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const wa = document.getElementById('reg-wa').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            
            const roleDataEl = document.getElementById('reg-jabatan-level');
            if (!roleDataEl.value) {
                showMessage('register-error-message', 'Jabatan & Level harus dipilih.', true);
                return;
            }
            const { jabatan, level } = JSON.parse(roleDataEl.value);

            showLoading(true);
            try {
                const payload = { action: 'register', nama, userid, password, wa, email, jabatan, level };
                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                });
                
                if (result.status === 'success') {
                    showMessage('register-error-message', 'Pendaftaran berhasil! Silakan login.', false);
                    document.getElementById('register-form').reset();
                    setTimeout(() => showPage('login'), 2000);
                } else {
                    showMessage('register-error-message', result.message || 'Pendaftaran gagal.', true);
                }
            } catch (error) {
                console.error('Register error:', error);
                showMessage('register-error-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        
        function openTambahSuratModal() {
            document.getElementById('surat-tanggal').value = new Date().toISOString().split('T')[0];
            showMessage('surat-form-message', '', false);
            document.getElementById('modal-tambah-surat').style.display = 'flex';
        }

        async function handleSuratSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('surat-file');
            if (fileInput.files.length === 0) {
                showMessage('surat-form-message', 'File surat wajib diupload.', true);
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (event) => {
                showLoading(true);
                const base64File = event.target.result.split(',')[1];
                const payload = {
                    action: 'input_surat',
                    jenis: 'Masuk',
                    nomor: document.getElementById('surat-nomor').value.trim(),
                    perihal: document.getElementById('surat-perihal').value.trim(),
                    tanggal: document.getElementById('surat-tanggal').value,
                    pengirim_penerima: document.getElementById('surat-pengirim').value.trim(),
                    fileName: file.name,
                    fileMimeType: file.type,
                    fileBase64: base64File,
                    userId: currentUser.id
                };

                try {
                    const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    if (result.status === 'success') {
                        showCustomAlert('Surat berhasil dikirim ke Direktur!', 'Berhasil');
                        document.getElementById('form-surat').reset();
                        document.getElementById('modal-tambah-surat').style.display='none';
                        loadSuratData('Masuk');
                    } else {
                        showMessage('surat-form-message', result.message || 'Gagal menyimpan surat.', true);
                    }
                } catch (error) {
                    console.error('Surat submit error:', error);
                    showMessage('surat-form-message', 'Terjadi kesalahan jaringan atau server.', true);
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsDataURL(file);
        }

        async function loadSuratData(jenis) {
            const listContainer = document.getElementById('surat-masuk-list');
            listContainer.innerHTML = '<p class="text-gray-200">Memuat data surat...</p>';
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_surat_list&jenis=${jenis}&userId=${currentUser.id}`);
                if (data.status === 'success') {
                    renderSuratMasukList(listContainer, data.surat);
                } else {
                    listContainer.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat data.'}</p>`;
                }
            } catch (error) {
                console.error(`Load Surat ${jenis} error:`, error);
                listContainer.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        function renderSuratMasukList(container, suratList) {
             if (!suratList || suratList.length === 0) {
                container.innerHTML = '<p class="text-gray-200">Belum ada data surat masuk yang diupload.</p>';
                return;
            }

            let html = `
            <table class="min-w-full divide-y divide-white/20">
                <thead class="bg-black/20">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Nomor Surat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Perihal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Pengirim</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Tanggal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-100 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/20">
            `;
            
            suratList.forEach(surat => {
                html += `
                    <tr data-search="${surat.nomor_surat} ${surat.perihal} ${surat.pengirim_penerima}" class="hover:bg-black/10">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${surat.nomor_surat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.perihal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.pengirim_penerima}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200">${surat.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="${surat.file_url}" target="_blank" class="text-amber-400 hover:text-amber-300 font-medium">Lihat File</a>
                            <button onclick="openRiwayatModal('${surat.id}', '${surat.nomor_surat.replace(/'/g, "\\'")}')" class="text-cyan-400 hover:text-cyan-300 font-medium ml-3">Riwayat</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        // --- DISPOSISI LOGIC ---
        
        function openDisposisiModal(suratId, parentDisposisiId, suratNomor) {
            document.getElementById('dispo-surat-id').value = suratId;
            document.getElementById('dispo-parent-id').value = parentDisposisiId;
            document.getElementById('dispo-surat-nomor').textContent = `No. Surat: ${suratNomor}`;
            
            const recipientList = document.getElementById('dispo-penerima-list');
            recipientList.innerHTML = ''; 

            const userLevel = parseInt(currentUser.level);
            let targetLevels = [];
            
            if (userLevel === 1) targetLevels = [2]; 
            else if (userLevel === 2) targetLevels = [3];
            else if (userLevel === 3) targetLevels = [4, 5];
            
            const recipients = allUsers.filter(u => targetLevels.includes(parseInt(u.level)) && u.status === 'Aktif');

            if (recipients.length > 0) {
                recipients.forEach(user => {
                    recipientList.innerHTML += `
                        <label class="flex items-center space-x-3 p-2 hover:bg-black/20 rounded-md cursor-pointer">
                            <input type="checkbox" name="dispo_penerima" value="${user.id}" class="w-4 h-4 rounded text-amber-500 bg-gray-700 border-gray-600 focus:ring-amber-600">
                            <span>${user.nama} <span class="text-xs text-gray-400">(${user.jabatan})</span></span>
                        </label>
                    `;
                });
            } else {
                recipientList.innerHTML = '<p class="text-gray-400">Tidak ada pengguna di level selanjutnya untuk menerima disposisi.</p>';
            }

            document.getElementById('modal-disposisi').style.display='flex';
            showMessage('dispo-form-message', '', false);
        }

        async function handleDisposisiSubmit(e) {
            e.preventDefault();
            const checkedBoxes = document.querySelectorAll('input[name="dispo_penerima"]:checked');
            const recipientIds = Array.from(checkedBoxes).map(cb => cb.value);

            if (recipientIds.length === 0) {
                 showMessage('dispo-form-message', 'Penerima disposisi wajib dipilih (minimal satu).', true);
                 return;
            }

            showLoading(true);
            const payload = {
                action: 'disposisi_surat',
                id_surat: document.getElementById('dispo-surat-id').value,
                parent_disposisi_id: document.getElementById('dispo-parent-id').value,
                dari_user_id: currentUser.id,
                ke_user_ids: recipientIds,
                catatan: document.getElementById('dispo-catatan').value.trim()
            };

            try {
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    showCustomAlert(result.message, 'Berhasil');
                    document.getElementById('form-disposisi').reset();
                    document.getElementById('modal-disposisi').style.display='none';
                    loadMyDisposisi();
                } else {
                    showMessage('dispo-form-message', result.message || 'Gagal mengirim disposisi.', true);
                }
            } catch (error) {
                console.error('Disposisi submit error:', error);
                showMessage('dispo-form-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadMyDisposisi() {
            const container = document.getElementById('my-disposisi-list');
            container.innerHTML = '<p class="text-gray-200">Memuat disposisi...</p>';
            
            showLoading(true);
            try {
                const [dispoData, userData] = await Promise.all([
                    fetchWithRetry(`${GAS_API_URL}?action=get_my_disposisi&userId=${currentUser.id}`),
                    fetchWithRetry(`${GAS_API_URL}?action=get_users&userId=${currentUser.id}`)
                ]);
                
                if (userData.status === 'success') allUsers = userData.users;

                if (dispoData.status === 'success') {
                    renderMyDisposisiList(container, dispoData.disposisi);
                } else {
                    container.innerHTML = `<p class="text-red-400">${dispoData.message || 'Gagal memuat data.'}</p>`;
                }
            } catch (error) {
                console.error('Load My Disposisi error:', error);
                container.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }

        function renderMyDisposisiList(container, disposisiList) {
             if (!disposisiList || disposisiList.length === 0) {
                container.innerHTML = '<p class="text-gray-200">Tidak ada disposisi baru untuk Anda.</p>';
                return;
            }

            let html = `<div class="space-y-4">`;
            
            disposisiList.forEach(d => {
                const userLevel = parseInt(currentUser.level);
                const isFinalLevel = [4, 5].includes(userLevel);
                const canForward = !isFinalLevel && d.status_tindak_lanjut !== 'Selesai' && d.status_tindak_lanjut !== 'Diteruskan';
                
                const forwardButton = canForward
                    ? `<button onclick="openDisposisiModal('${d.id_surat}', '${d.id}', '${d.nomor_surat.replace(/'/g, "\\'")}')" class="text-sm bg-amber-600/50 hover:bg-amber-600/80 text-white font-medium py-1 px-3 rounded-md flex items-center space-x-2"><i data-lucide="send" class="w-4 h-4"></i><span>Disposisi Lanjut</span></button>`
                    : '';
                
                const statusUpdateOptions = d.status_tindak_lanjut !== 'Selesai' && d.status_tindak_lanjut !== 'Diteruskan'
                    ? `<select onchange="updateDisposisiStatus('${d.id}', 'tindak_lanjut', this.value)" class="text-sm border rounded p-1 form-input">
                        <option class="text-black" value="Belum Diproses" ${d.status_tindak_lanjut === 'Belum Diproses' ? 'selected' : ''}>Belum Diproses</option>
                        <option class="text-black" value="Diproses" ${d.status_tindak_lanjut === 'Diproses' ? 'selected' : ''}>Diproses</option>
                        <option class="text-black" value="Selesai" ${d.status_tindak_lanjut === 'Selesai' ? 'selected' : ''}>Selesai</option>
                       </select>`
                    : `<span class="text-sm font-semibold text-gray-300">${d.status_tindak_lanjut}</span>`;

                html += `
                    <div class="glass-card p-4 border-l-4 ${d.status_baca === 'Belum Dibaca' ? 'border-red-500' : 'border-gray-500'}">
                        <div class="flex flex-wrap justify-between items-start gap-2">
                             <div>
                                <p class="font-bold text-white">${d.nomor_surat}</p>
                                <p class="text-sm text-gray-200">${d.perihal}</p>
                                <p class="text-xs text-gray-300 mt-1">Dari: <strong>${d.dari_user_nama}</strong> &bull; ${new Date(d.tanggal_disposisi).toLocaleString('id-ID')}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${statusUpdateOptions}
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-black/20 rounded-md">
                            <p class="text-sm text-gray-100"><strong>Instruksi:</strong> ${d.catatan || 'Tidak ada catatan.'}</p>
                        </div>
                        <div class="mt-3 flex items-center space-x-4">
                            <a href="${d.file_url}" target="_blank" class="text-sm text-amber-400 hover:underline font-medium">Lihat File Surat</a>
                            <button onclick="openRiwayatModal('${d.id_surat}', '${d.nomor_surat.replace(/'/g, "\\'")}')" class="text-sm text-cyan-400 hover:underline font-medium">Riwayat</button>
                            ${d.status_baca === 'Belum Dibaca' ? `<button onclick="updateDisposisiStatus('${d.id}', 'baca')" class="text-sm text-amber-400 hover:underline font-medium">Tandai Dibaca</button>` : ''}
                            ${forwardButton}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
        }

        async function updateDisposisiStatus(disposisiId, statusType, value = null) {
            showLoading(true);
            try {
                const payload = { action: 'update_disposisi_status', id: disposisiId, statusType, value, userId: currentUser.id };
                const result = await fetchWithRetry(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                if (result.status === 'success') {
                    loadMyDisposisi(); 
                    loadDashboardData(); 
                } else {
                    showCustomAlert('Gagal update status: ' + (result.message || 'Terjadi kesalahan.'), 'Kesalahan Update');
                }
            } catch (error) {
                console.error('Update status error:', error);
                showCustomAlert('Terjadi kesalahan jaringan/server: ' + error.message, 'Kesalahan Jaringan');
            } finally {
                showLoading(false);
            }
        }

        // --- NEW HISTORY FUNCTIONS ---

        async function openRiwayatModal(suratId, suratNomor) {
            const modal = document.getElementById('modal-riwayat');
            const container = document.getElementById('riwayat-timeline-container');
            
            document.getElementById('riwayat-surat-nomor').textContent = `No. Surat: ${suratNomor}`;
            container.innerHTML = '<p class="text-gray-200">Memuat riwayat surat...</p>';
            modal.style.display = 'flex';
            
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_surat_history&suratId=${suratId}`);
                if (data.status === 'success') {
                    renderRiwayat(container, data.history);
                } else {
                    container.innerHTML = `<p class="text-red-400">${data.message || 'Gagal memuat riwayat.'}</p>`;
                }
            } catch (error) {
                console.error('Load History error:', error);
                container.innerHTML = `<p class="text-red-400">Kesalahan jaringan: ${error.message}</p>`;
            }
        }

        function renderRiwayat(container, history) {
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-gray-400">Tidak ada riwayat untuk surat ini.</p>';
                return;
            }

            let html = '<div class="relative border-l-2 border-white/20 ml-3">';
            
            history.forEach((item) => {
                html += `
                    <div class="mb-8 ml-6">
                        <span class="absolute flex items-center justify-center w-6 h-6 bg-amber-500 rounded-full -left-3 ring-4 ring-amber-900/50">
                            <i data-lucide="check" class="w-4 h-4 text-white"></i>
                        </span>
                        <h3 class="flex items-center mb-1 text-lg font-semibold text-white">${item.actor}</h3>
                        <time class="block mb-2 text-sm font-normal leading-none text-gray-400">${new Date(item.timestamp).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' })}</time>
                        <p class="mb-2 text-base font-normal text-gray-200">${item.action}</p>
                        <p class="text-sm font-italic text-gray-300 bg-black/20 p-2 rounded-md">Catatan: ${item.detail}</p>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            lucide.createIcons();
        }
        
        // --- OTHER FUNCTIONS (UNCHANGED) ---
        async function loadDashboardData() { /* Omitted for brevity */ }
        async function loadUserManagement() { /* Omitted for brevity */ }
        async function loadLogData() { /* Omitted for brevity */ }
        async function loadArsipData() { /* Omitted for brevity */ }

    </script>
</body>
</html>

