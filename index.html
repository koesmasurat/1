<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Surat RSUD dr. R. Koesma</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --main-color: #10b981; /* Emerald 500 */ }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .active-link { border-left: 4px solid var(--main-color); background-color: #ecfdf5; font-weight: 600; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 50; justify-content: center; align-items: center; }
        .modal { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-main-color" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Main App Container -->
    <div id="app" class="flex">
        <!-- Sidebar (Hidden by default, shown by JS only when logged in) -->
        <div id="sidebar" class="hidden fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out bg-white w-64 shadow-xl z-40">
            <div class="p-6 border-b">
                <h1 class="text-xl font-bold text-gray-800">SIMAS RSUD</h1>
                <p class="text-sm text-gray-500">dr. R. Koesma</p>
            </div>
            <nav class="mt-6">
                <a href="#dashboard" onclick="showPage('dashboard')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span>
                </a>
                <a href="#surat-masuk" onclick="showPage('surat-masuk')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="mail-check" class="w-5 h-5"></i><span>Surat Masuk</span>
                </a>
                <a href="#surat-keluar" onclick="showPage('surat-keluar')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="send" class="w-5 h-5"></i><span>Surat Keluar</span>
                </a>
                <a href="#disposisi" onclick="showPage('disposisi')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="layers-3" class="w-5 h-5"></i><span>Disposisi Saya</span>
                </a>
                <a href="#arsip" onclick="showPage('arsip')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="archive" class="w-5 h-5"></i><span>Arsip Dokumen</span>
                </a>
                <a href="#users" onclick="showPage('users')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="users" class="w-5 h-5"></i><span>Manajemen User</span>
                </a>
                <a href="#log" onclick="showPage('log')" class="nav-link block px-6 py-3 text-gray-700 hover:bg-gray-50 rounded-r-full flex items-center space-x-3">
                    <i data-lucide="file-text" class="w-5 h-5"></i><span>Log Aktivitas</span>
                </a>
            </nav>
            <div class="absolute bottom-0 p-6 w-full border-t">
                <button onclick="logout()" class="w-full text-left flex items-center space-x-3 text-red-600 hover:text-red-800 transition duration-150">
                    <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
                </button>
            </div>
        </div>
        
        <!-- Content Area (md:ml-64 added dynamically if logged in) -->
        <div id="content-area" class="flex-1 transition-all duration-200 p-4 md:p-8">
            <!-- Mobile Menu Toggle (Only visible if sidebar is shown, managed by JS) -->
            <button id="menu-toggle" class="md:hidden p-2 rounded-full bg-white shadow-md mb-4 fixed top-4 right-4 z-50">
                <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
            </button>

            <!-- Pages -->
            <div id="pages-container">
                <!-- Login Page -->
                <div id="login-page" class="page max-w-md mx-auto mt-20 p-8 bg-white shadow-xl rounded-xl">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login SIMAS RSUD</h2>
                    <p class="text-sm text-center text-red-500 mb-4" id="login-error-message"></p>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-wa" class="block text-sm font-medium text-gray-700">Nomor WA</label>
                            <input type="text" id="login-wa" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Contoh: 6281xxxx">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                        </div>
                        <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150">
                            Masuk
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-600">
                        Belum punya akun? <a href="#" onclick="showPage('register')" class="font-medium text-emerald-600 hover:text-emerald-500">Daftar Sekarang</a>
                    </p>
                </div>
                
                <!-- Register Page -->
                <div id="register-page" class="page max-w-lg mx-auto mt-10 p-8 bg-white shadow-xl rounded-xl hidden">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Pendaftaran Akun Baru</h2>
                    <p class="text-sm text-center text-red-500 mb-4" id="register-error-message"></p>
                    <form id="register-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="reg-nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                <input type="text" id="reg-nama" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="reg-wa" class="block text-sm font-medium text-gray-700">Nomor WA (ID Login)</label>
                                <input type="text" id="reg-wa" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="6281xxxx">
                            </div>
                            <div>
                                <label for="reg-email" class="block text-sm font-medium text-gray-700">Email (Opsional)</label>
                                <input type="email" id="reg-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="reg-jabatan" class="block text-sm font-medium text-gray-700">Jabatan</label>
                                <input type="text" id="reg-jabatan" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="reg-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="reg-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <button type="submit" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700">
                            Daftar
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-600">
                        Sudah punya akun? <a href="#" onclick="showPage('login')" class="font-medium text-emerald-600 hover:text-emerald-500">Login</a>
                    </p>
                </div>

                <!-- Dashboard Page (Content populated by JS) -->
                <div id="dashboard-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
                    <p class="text-md text-gray-600 mb-6">Selamat datang, <span id="user-display-name" class="font-semibold"></span>! Jabatan: <span id="user-display-jabatan" class="font-semibold"></span></p>
                    <div id="dashboard-content">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                                <p class="text-sm font-medium text-gray-500">Surat Masuk Bulan Ini</p>
                                <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-masuk">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500">
                                <p class="text-sm font-medium text-gray-500">Surat Belum Didisposisi</p>
                                <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-undisposed">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-500">
                                <p class="text-sm font-medium text-gray-500">Surat Belum Ditindaklanjuti</p>
                                <p class="text-3xl font-bold text-gray-900 mt-1" id="stat-unfollowed">0</p>
                            </div>
                        </div>

                        <!-- Notification/Surat List -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Disposisi Terbaru untuk Anda</h3>
                            <div id="disposisi-list-dashboard">
                                <p class="text-gray-500">Memuat data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Surat Masuk Page -->
                <div id="surat-masuk-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Surat Masuk</h2>
                    <button onclick="document.getElementById('modal-tambah-surat').style.display='flex';" class="mb-6 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Tambah Surat Masuk
                    </button>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="mb-4">
                            <input type="text" id="search-surat" onkeyup="filterSurat('surat-masuk-list', this.value)" placeholder="Cari: Nomor/Perihal/Pengirim" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div id="surat-masuk-list" class="overflow-x-auto">
                            <p class="text-gray-500">Data surat masuk akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>

                <!-- Surat Keluar Page (Simplifikasi: Sama dengan Masuk, hanya label berbeda) -->
                <div id="surat-keluar-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Surat Keluar</h2>
                    <button onclick="document.getElementById('modal-tambah-surat').style.display='flex';" class="mb-6 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-emerald-700 transition duration-150 flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Tambah Surat Keluar
                    </button>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="mb-4">
                            <input type="text" id="search-surat-keluar" onkeyup="filterSurat('surat-keluar-list', this.value)" placeholder="Cari: Nomor/Perihal/Penerima" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div id="surat-keluar-list" class="overflow-x-auto">
                            <p class="text-gray-500">Data surat keluar akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>

                <!-- Disposisi Saya Page -->
                <div id="disposisi-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Disposisi Saya</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div id="my-disposisi-list" class="overflow-x-auto">
                            <p class="text-gray-500">Daftar disposisi untuk Anda akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>

                <!-- Arsip Page -->
                <div id="arsip-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Arsip Dokumen</h2>
                    <p class="text-gray-600 mb-6">Lihat semua arsip surat yang tersimpan di Google Drive.</p>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div id="arsip-list">
                            <p class="text-gray-500">Data arsip akan dimuat di sini...</p>
                        </div>
                    </div>
                </div>
                
                <!-- User Management Page -->
                <div id="users-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Manajemen User</h2>
                    <div id="user-management-content" class="bg-white p-6 rounded-xl shadow-lg">
                        <p class="text-gray-500">Daftar pengguna akan dimuat di sini...</p>
                    </div>
                </div>

                <!-- Log Page -->
                <div id="log-page" class="page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Log Aktivitas</h2>
                    <div id="log-content" class="bg-white p-6 rounded-xl shadow-lg">
                        <p class="text-gray-500">Log sistem akan dimuat di sini...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Tambah Surat -->
    <div id="modal-tambah-surat" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full justify-center items-center z-50">
        <div class="relative p-5 w-full max-w-2xl bg-white rounded-xl shadow-xl">
            <h3 class="text-xl font-bold mb-4">Input Surat</h3>
            <form id="form-surat">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Jenis Surat</label>
                    <select id="surat-jenis" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="Masuk">Surat Masuk</option>
                        <option value="Keluar">Surat Keluar</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Nomor Surat</label>
                    <input type="text" id="surat-nomor" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Perihal</label>
                    <input type="text" id="surat-perihal" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Tanggal Surat</label>
                    <input type="date" id="surat-tanggal" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700" id="label-pengirim">Pengirim</label>
                    <input type="text" id="surat-pengirim" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Upload File (PDF/DOCX/JPG/PNG)</label>
                    <input type="file" id="surat-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required class="mt-1 block w-full">
                </div>
                <div id="surat-form-message" class="text-sm text-red-500 mb-4"></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="document.getElementById('modal-tambah-surat').style.display='none';" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">Simpan Surat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Disposisi -->
    <div id="modal-disposisi" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full justify-center items-center z-50">
        <div class="relative p-5 w-full max-w-xl bg-white rounded-xl shadow-xl">
            <h3 class="text-xl font-bold mb-4">Disposisi Surat: <span id="dispo-surat-nomor" class="text-emerald-600"></span></h3>
            <form id="form-disposisi">
                <input type="hidden" id="dispo-surat-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Pilih Penerima Disposisi</label>
                    <select id="dispo-penerima" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        <!-- Options filled by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Instruksi/Catatan</label>
                    <textarea id="dispo-catatan" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div id="dispo-form-message" class="text-sm text-red-500 mb-4"></div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="document.getElementById('modal-disposisi').style.display='none';" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Kirim Disposisi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Custom Alert/Confirm (Ganti Alert/Confirm native) -->
    <div id="modal-custom" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full justify-center items-center z-50">
        <div class="relative p-6 w-full max-w-sm bg-white rounded-xl shadow-2xl">
            <h3 id="custom-modal-title" class="text-lg font-bold mb-3 text-gray-800">Notifikasi</h3>
            <p id="custom-modal-message" class="text-sm text-gray-700 mb-6"></p>
            <div id="custom-modal-actions" class="flex justify-end space-x-2">
                <!-- Action buttons inserted by JS -->
            </div>
        </div>
    </div>

    <script>
        // *** PENTING: GANTI URL INI dengan URL Web App Google Apps Script Anda yang sudah di-deploy. ***
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwQvV3PoztdzPD4-eYznz_WKtUlNDRfLeyKPXKfxzqeLWhhdpyIa6QSFlXhMfpCuoU/exec'; 
        
        let currentUser = null;
        let allUsers = []; // Stores the list of all users for disposition purposes
        let confirmCallback = null; // Callback for the custom confirm modal

        // --- UTILITY FUNCTIONS ---
        
        /** Displays a notification message */
        function showMessage(elementId, message, isError = true) {
            const el = document.getElementById(elementId);
            if(el) {
                el.textContent = message;
                el.className = `text-sm mb-4 ${isError ? 'text-red-500' : 'text-green-600'}`;
                if (!message) el.className += ' hidden';
                else el.className = el.className.replace(' hidden', '');
            }
        }
        
        /** Shows a custom alert modal (replaces native alert()) */
        function showCustomAlert(message, title = 'Notifikasi') {
            const modal = document.getElementById('modal-custom');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').textContent = message;
            
            const actions = document.getElementById('custom-modal-actions');
            actions.innerHTML = `<button onclick="document.getElementById('modal-custom').style.display='none';" class="px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700">OK</button>`;
            modal.style.display = 'flex';
        }
        
        /** Shows a custom confirm modal (replaces native confirm()) */
        function showCustomConfirm(message, callback) {
            const modal = document.getElementById('modal-custom');
            document.getElementById('custom-modal-title').textContent = 'Konfirmasi Tindakan';
            document.getElementById('custom-modal-message').textContent = message;
            confirmCallback = callback;

            const actions = document.getElementById('custom-modal-actions');
            actions.innerHTML = `
                <button id="btn-cancel" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Batal</button>
                <button id="btn-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Ya, Lanjutkan</button>
            `;
            
            document.getElementById('btn-cancel').onclick = () => {
                modal.style.display = 'none';
                if (confirmCallback) confirmCallback(false);
            };
            document.getElementById('btn-confirm').onclick = () => {
                modal.style.display = 'none';
                if (confirmCallback) confirmCallback(true);
            };

            modal.style.display = 'flex';
        }


        /** Shows or hides the loading overlay */
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }
        
        /**
         * A wrapper for the fetch API that includes retry logic with exponential backoff.
         * This is crucial for handling intermittent network issues or temporary server errors.
         * @param {string} url The URL to fetch.
         * @param {object} options The fetch options (method, headers, body, etc.).
         * @param {number} retries The number of retry attempts.
         * @returns {Promise<object>} A promise that resolves with the JSON response.
         */
        async function fetchWithRetry(url, options = {}, retries = 3) {
            let attempt = 0;
            while (attempt < retries) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // For non-network errors (e.g., 500, 404), don't retry, just throw.
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    // Handle cases where GAS returns HTML error pages instead of JSON
                    const text = await response.text();
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                         console.error("Failed to parse JSON:", text);
                         throw new Error("Received non-JSON response from server.");
                    }
                } catch (error) {
                    attempt++;
                    console.warn(`Fetch attempt ${attempt} failed: ${error.message}. Retrying...`);
                    if (attempt >= retries) {
                        throw error; // Throw the final error after all retries fail.
                    }
                    // Exponential backoff: wait 1s, then 2s, etc., before retrying.
                    await new Promise(res => setTimeout(res, 1000 * attempt));
                }
            }
        }


        // --- AUTHENTICATION & ROUTING ---

        /** Checks login status when the app loads */
        function checkLoginStatus() {
            const userData = localStorage.getItem('currentUser');
            const sidebarEl = document.getElementById('sidebar');
            const contentAreaEl = document.getElementById('content-area');

            if (userData) {
                currentUser = JSON.parse(userData);
                document.getElementById('user-display-name').textContent = currentUser.nama;
                document.getElementById('user-display-jabatan').textContent = currentUser.jabatan;
                
                contentAreaEl.classList.add('md:ml-64');
                sidebarEl.classList.remove('hidden');

                const initialHash = window.location.hash.substring(1) || 'dashboard';
                showPage(initialHash);
            } else {
                currentUser = null;
                
                contentAreaEl.classList.remove('md:ml-64');
                sidebarEl.classList.add('hidden');
                
                showPage('login');
            }
            lucide.createIcons(); 
        }

        /** Displays a page based on its ID */
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));

            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link'));
                const activeLink = document.querySelector(`a[href="#${pageId}"]`);
                if (activeLink) activeLink.classList.add('active-link');

                if (currentUser) {
                    window.location.hash = pageId;
                    switch (pageId) {
                        case 'dashboard': loadDashboardData(); break;
                        case 'surat-masuk': loadSuratData('Masuk'); break;
                        case 'surat-keluar': loadSuratData('Keluar'); break;
                        case 'disposisi': loadMyDisposisi(); break;
                        case 'users': loadUserManagement(); break;
                        case 'log': loadLogData(); break;
                        case 'arsip': loadArsipData(); break;
                    }
                }
            } else if (pageId === 'login' || pageId === 'register') {
                document.getElementById(pageId + '-page').classList.remove('hidden');
                window.location.hash = '';
            }
        }

        /** Logs out the user */
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            // A full reload ensures all states are cleared properly.
            window.location.href = window.location.pathname;
        }

        // --- EVENT LISTENERS & HANDLERS ---

        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();

            const sidebar = document.getElementById('sidebar');
            document.getElementById('menu-toggle').addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('form-surat').addEventListener('submit', handleSuratSubmit);
            document.getElementById('form-disposisi').addEventListener('submit', handleDisposisiSubmit);
            
            document.getElementById('surat-jenis').addEventListener('change', (e) => {
                document.getElementById('label-pengirim').textContent = e.target.value === 'Masuk' ? 'Pengirim' : 'Penerima';
            });
        });


        // --- GAS API INTERACTION FUNCTIONS ---

        async function handleLogin(e) {
            e.preventDefault();
            const wa = document.getElementById('login-wa').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!GAS_API_URL.startsWith('https://')) {
                showCustomAlert('ERROR: Harap ganti variabel GAS_API_URL dengan URL Web App Anda di kode HTML.', 'Kesalahan Konfigurasi');
                return;
            }

            showLoading(true);
            try {
                // Using GET with plain password as per the backend script's design
                const url = `${GAS_API_URL}?action=login&wa=${encodeURIComponent(wa)}&password=${encodeURIComponent(password)}`;
                
                const data = await fetchWithRetry(url, { method: 'GET' });

                if (data.status === 'success') {
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    checkLoginStatus(); // Re-initialize app state
                } else {
                    showMessage('login-error-message', data.message || 'Login gagal. Cek nomor WA/Password.', true);
                }
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Terjadi kesalahan jaringan atau server. Pastikan URL GAS benar dan Web App di-deploy ulang dengan akses "Anyone".';
                showMessage('login-error-message', errorMessage, true);
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = document.getElementById('register-form');
            const password = form['reg-password'].value.trim();

            showLoading(true);
            try {
                // Using GET with plain password
                const params = new URLSearchParams({
                    action: 'register',
                    nama: form['reg-nama'].value.trim(),
                    wa: form['reg-wa'].value.trim(),
                    email: form['reg-email'].value.trim(),
                    jabatan: form['reg-jabatan'].value.trim(),
                    password: password
                });
                const url = `${GAS_API_URL}?${params.toString()}`;

                const result = await fetchWithRetry(url, { method: 'GET' });

                if (result.status === 'success') {
                    showMessage('register-error-message', 'Pendaftaran berhasil! Silakan login.', false);
                    form.reset();
                    setTimeout(() => showPage('login'), 2000);
                } else {
                    showMessage('register-error-message', result.message || 'Pendaftaran gagal.', true);
                }
            } catch (error) {
                console.error('Register error:', error);
                let errorMessage = 'Terjadi kesalahan jaringan atau server. Pastikan URL GAS benar dan Web App di-deploy ulang dengan akses "Anyone".';
                showMessage('register-error-message', errorMessage, true);
            } finally {
                showLoading(false);
            }
        }

        async function handleSuratSubmit(e) {
            e.preventDefault();
            
            const form = document.getElementById('form-surat');
            const fileInput = document.getElementById('surat-file');
            
            if (fileInput.files.length === 0) {
                showMessage('surat-form-message', 'File surat wajib diupload.', true);
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(event) {
                showLoading(true);
                const base64File = event.target.result.split(',')[1];

                const payload = {
                    action: 'input_surat',
                    jenis: form['surat-jenis'].value,
                    nomor: form['surat-nomor'].value.trim(),
                    perihal: form['surat-perihal'].value.trim(),
                    tanggal: form['surat-tanggal'].value,
                    pengirim_penerima: form['surat-pengirim'].value.trim(),
                    fileName: file.name,
                    fileMimeType: file.type,
                    fileBase64: base64File,
                    userId: currentUser.id
                };

                try {
                    // All API calls other than login/register use POST with a JSON body
                    const result = await fetchWithRetry(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                    });

                    if (result.status === 'success') {
                        showCustomAlert('Surat berhasil disimpan dan diarsip!', 'Berhasil');
                        form.reset();
                        document.getElementById('modal-tambah-surat').style.display='none';
                        loadSuratData(payload.jenis); // Refresh list
                    } else {
                        showMessage('surat-form-message', result.message || 'Gagal menyimpan surat.', true);
                    }
                } catch (error) {
                    console.error('Surat submit error:', error);
                    let errorMessage = 'Terjadi kesalahan jaringan atau server.';
                    showMessage('surat-form-message', errorMessage, true);
                } finally {
                    showLoading(false);
                }
            };
            
            reader.readAsDataURL(file);
        }

        async function loadSuratData(jenis) {
            const listId = jenis === 'Masuk' ? 'surat-masuk-list' : 'surat-keluar-list';
            const listContainer = document.getElementById(listId);
            listContainer.innerHTML = '<p class="text-gray-500">Memuat data surat...</p>';
            
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_surat_list&jenis=${jenis}&userId=${currentUser.id}`);
                
                if (data.status === 'success') {
                    allUsers = data.users || []; // Store the user list
                    renderSuratList(listContainer, data.surat, jenis);
                } else {
                    listContainer.innerHTML = `<p class="text-red-500">${data.message || 'Gagal memuat data surat.'}</p>`;
                }
            } catch (error) {
                console.error(`Load Surat ${jenis} error:`, error);
                listContainer.innerHTML = `<p class="text-red-500">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        function renderSuratList(container, suratList, jenis) {
            if (!suratList || suratList.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Belum ada data surat.</p>';
                return;
            }

            let html = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nomor Surat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perihal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${jenis === 'Masuk' ? 'Pengirim' : 'Penerima'}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            suratList.forEach(surat => {
                const statusColor = surat.status === 'Belum Disposisi' ? 'bg-yellow-100 text-yellow-800' : 'bg-emerald-100 text-emerald-800';
                
                const disposisiButton = (currentUser.jabatan === 'Pimpinan' || currentUser.jabatan === 'Admin') && jenis === 'Masuk'
                    ? `<button onclick="openDisposisiModal('${surat.id}', '${surat.nomor_surat.replace(/'/g, "\\'")}')" class="text-blue-600 hover:text-blue-800 font-medium ml-3">Disposisi</button>`
                    : '';
                    
                html += `
                    <tr data-search="${surat.nomor_surat} ${surat.perihal} ${surat.pengirim_penerima}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${surat.nomor_surat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${surat.perihal}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${surat.pengirim_penerima}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${surat.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${surat.status}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="${surat.file_url}" target="_blank" class="text-emerald-600 hover:text-emerald-800 font-medium">Lihat File</a>
                            ${disposisiButton}
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // --- DISPOSISI LOGIC ---

        function openDisposisiModal(suratId, suratNomor) {
            document.getElementById('dispo-surat-id').value = suratId;
            document.getElementById('dispo-surat-nomor').textContent = suratNomor;
            
            const select = document.getElementById('dispo-penerima');
            select.innerHTML = '<option value="">Pilih Penerima</option>';
            
            allUsers.filter(u => u.id !== currentUser.id && u.status === 'Aktif').forEach(user => {
                select.innerHTML += `<option value="${user.id}">${user.nama} (${user.jabatan})</option>`;
            });
            
            document.getElementById('modal-disposisi').style.display='flex';
            showMessage('dispo-form-message', '', false);
        }

        async function handleDisposisiSubmit(e) {
            e.preventDefault();
            const suratId = document.getElementById('dispo-surat-id').value;
            const penerimaId = document.getElementById('dispo-penerima').value;
            const catatan = document.getElementById('dispo-catatan').value.trim();

            if (!penerimaId) {
                 showMessage('dispo-form-message', 'Penerima disposisi wajib dipilih.', true);
                 return;
            }

            showLoading(true);
            try {
                const payload = {
                    action: 'disposisi_surat',
                    id_surat: suratId,
                    dari_user_id: currentUser.id,
                    ke_user_id: penerimaId,
                    catatan: catatan
                };

                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (result.status === 'success') {
                    showCustomAlert('Disposisi berhasil dikirim. Notifikasi WA/Telegram sedang diproses.', 'Berhasil');
                    document.getElementById('form-disposisi').reset();
                    document.getElementById('modal-disposisi').style.display='none';
                    loadSuratData('Masuk');
                } else {
                    showMessage('dispo-form-message', result.message || 'Gagal mengirim disposisi.', true);
                }
            } catch (error) {
                console.error('Disposisi submit error:', error);
                showMessage('dispo-form-message', 'Terjadi kesalahan jaringan atau server.', true);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadMyDisposisi() {
            const container = document.getElementById('my-disposisi-list');
            container.innerHTML = '<p class="text-gray-500">Memuat disposisi...</p>';
            
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_my_disposisi&userId=${currentUser.id}`);
                
                if (data.status === 'success') {
                    renderMyDisposisiList(container, data.disposisi);
                } else {
                    container.innerHTML = `<p class="text-red-500">${data.message || 'Gagal memuat data disposisi.'}</p>`;
                }
            } catch (error) {
                console.error('Load My Disposisi error:', error);
                container.innerHTML = `<p class="text-red-500">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }

        function renderMyDisposisiList(container, disposisiList) {
             if (!disposisiList || disposisiList.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Tidak ada disposisi baru untuk Anda.</p>';
                return;
            }

            let html = `
            <div class="space-y-4">
            `;
            
            disposisiList.forEach(d => {
                const statusBacaColor = d.status_baca === 'Belum Dibaca' ? 'text-red-600' : 'text-green-600';
                const statusTLColor = d.status_tindak_lanjut === 'Belum Diproses' ? 'text-yellow-600' : (d.status_tindak_lanjut === 'Diproses' ? 'text-blue-600' : 'text-emerald-600');
                
                const markReadButton = d.status_baca === 'Belum Dibaca'
                    ? `<button onclick="updateDisposisiStatus('${d.id}', 'baca')" class="text-sm text-blue-600 hover:underline font-medium">Tandai Dibaca</button>`
                    : '';
                
                const markTLSelect = d.status_tindak_lanjut !== 'Selesai'
                    ? `<select onchange="updateDisposisiStatus('${d.id}', 'tindak_lanjut', this.value)" class="text-sm border rounded p-1">
                        <option value="Belum Diproses" ${d.status_tindak_lanjut === 'Belum Diproses' ? 'selected' : ''}>Belum Diproses</option>
                        <option value="Diproses" ${d.status_tindak_lanjut === 'Diproses' ? 'selected' : ''}>Diproses</option>
                        <option value="Selesai" ${d.status_tindak_lanjut === 'Selesai' ? 'selected' : ''}>Selesai</option>
                       </select>`
                    : `<span class="text-sm font-semibold ${statusTLColor}">Selesai</span>`;

                html += `
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 ${d.status_baca === 'Belum Dibaca' ? 'border-red-500' : 'border-gray-300'}">
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="font-bold text-gray-800">${d.nomor_surat}</p>
                                <p class="text-sm text-gray-600">${d.perihal}</p>
                                <p class="text-xs text-gray-500 mt-1">Dari: <strong>${d.dari_user_nama}</strong> &bull; ${d.tanggal_disposisi}</p>
                            </div>
                            <div class="flex-shrink-0 ml-4">
                                ${markTLSelect}
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-gray-50 rounded-md">
                            <p class="text-sm text-gray-700"><strong>Instruksi:</strong> ${d.catatan || 'Tidak ada catatan.'}</p>
                        </div>
                        <div class="mt-3 flex items-center space-x-4">
                            <a href="${d.file_url}" target="_blank" class="text-sm text-emerald-600 hover:underline font-medium">Lihat File Surat</a>
                            ${markReadButton}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }

        async function updateDisposisiStatus(disposisiId, statusType, value = null) {
            showLoading(true);
            try {
                const payload = {
                    action: 'update_disposisi_status',
                    id: disposisiId,
                    statusType: statusType, // 'baca' or 'tindak_lanjut'
                    value: value, // for tindak_lanjut
                    userId: currentUser.id
                };

                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (result.status === 'success') {
                    // Refresh lists without showing an alert
                    loadMyDisposisi(); 
                    loadDashboardData(); 
                } else {
                    showCustomAlert('Gagal update status: ' + (result.message || 'Terjadi kesalahan.'), 'Kesalahan Update');
                }
            } catch (error) {
                console.error('Update status error:', error);
                showCustomAlert('Terjadi kesalahan jaringan/server: ' + error.message, 'Kesalahan Jaringan');
            } finally {
                showLoading(false);
            }
        }
        
        // --- DASHBOARD, ARSIP, USER, LOG ---

        async function loadDashboardData() {
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_dashboard_data&userId=${currentUser.id}`);
                
                if (data.status === 'success') {
                    document.getElementById('stat-masuk').textContent = data.stats.suratMasukBulanIni || 0;
                    document.getElementById('stat-undisposed').textContent = data.stats.belumDidisposisi || 0;
                    document.getElementById('stat-unfollowed').textContent = data.stats.belumDitindaklanjuti || 0;

                    const container = document.getElementById('disposisi-list-dashboard');
                    if (data.latestDisposisi && data.latestDisposisi.length > 0) {
                         let html = '';
                         data.latestDisposisi.slice(0, 5).forEach(d => {
                            html += `
                                <div class="p-3 border-b hover:bg-gray-50 rounded-lg">
                                    <p class="font-semibold text-gray-800">${d.perihal}</p>
                                    <p class="text-sm text-gray-600">Disposisi dari <strong>${d.dari_user_nama}</strong>. 
                                    Status: <span class="font-medium ${d.status_baca === 'Belum Dibaca' ? 'text-red-600' : 'text-green-600'}">${d.status_baca}</span></p>
                                </div>
                            `;
                         });
                         container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-gray-500">Tidak ada disposisi atau notifikasi terbaru.</p>';
                    }
                }
            } catch (error) {
                console.error('Load Dashboard error:', error);
            } finally {
                showLoading(false);
            }
        }

        async function loadUserManagement() {
            const container = document.getElementById('user-management-content');
            if (currentUser.jabatan !== 'Admin') {
                container.innerHTML = '<p class="text-red-500 font-semibold">Anda tidak memiliki izin untuk mengakses halaman ini.</p>';
                return;
            }

            container.innerHTML = '<p class="text-gray-500">Memuat daftar user...</p>';
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_users&userId=${currentUser.id}`);
                
                if (data.status === 'success') {
                    renderUserList(container, data.users);
                } else {
                    container.innerHTML = `<p class="text-red-500">${data.message || 'Gagal memuat data user.'}</p>`;
                }
            } catch (error) {
                console.error('Load User Management error:', error);
                container.innerHTML = `<p class="text-red-500">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        function renderUserList(container, userList) {
            let html = `
            <p class="text-sm text-gray-600 mb-4">Hanya Admin yang dapat mereset password user. Password akan di-reset menjadi 'password123'.</p>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WA</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            userList.forEach(user => {
                const statusColor = user.status === 'Aktif' ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800';
                const actionButton = user.id !== currentUser.id
                    ? `<button onclick="triggerResetPassword('${user.id}')" class="text-red-600 hover:text-red-800 font-medium">Reset Pass</button>`
                    : `<span class="text-gray-400">Akun Anda</span>`;

                html += `
                    <tr>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.nama}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.wa}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${user.jabatan}</td>
                        <td class="px-4 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${user.status}</span></td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">${actionButton}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function triggerResetPassword(userId) {
            showCustomConfirm('Yakin ingin mereset password user ini menjadi "password123"? Tindakan ini tidak dapat dibatalkan.', (confirmed) => {
                if (confirmed) {
                    resetUserPassword(userId);
                }
            });
        }

        async function resetUserPassword(userId) {
            showLoading(true);
            try {
                const payload = {
                    action: 'reset_password',
                    targetUserId: userId,
                    adminUserId: currentUser.id
                };

                const result = await fetchWithRetry(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (result.status === 'success') {
                    showCustomAlert('Password berhasil direset menjadi "password123". Harap segera informasikan kepada user.', 'Reset Berhasil');
                    loadUserManagement();
                } else {
                    showCustomAlert('Gagal reset password: ' + (result.message || 'Terjadi kesalahan.'), 'Reset Gagal');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showCustomAlert('Terjadi kesalahan jaringan/server: ' + error.message, 'Kesalahan Jaringan');
            } finally {
                showLoading(false);
            }
        }
        
        function filterSurat(listId, query) {
            const rows = document.getElementById(listId).querySelectorAll('tbody tr');
            const lowerCaseQuery = query.toLowerCase();

            rows.forEach(row => {
                const searchData = row.getAttribute('data-search').toLowerCase();
                row.style.display = searchData.includes(lowerCaseQuery) ? '' : 'none';
            });
        }
        
        async function loadLogData() {
            const container = document.getElementById('log-content');
             if (currentUser.jabatan !== 'Admin') {
                container.innerHTML = '<p class="text-red-500 font-semibold">Hanya Admin yang dapat melihat Log Aktivitas.</p>';
                return;
            }
            container.innerHTML = '<p class="text-gray-500">Memuat log aktivitas...</p>';
            
            showLoading(true);
            try {
                const data = await fetchWithRetry(`${GAS_API_URL}?action=get_log&userId=${currentUser.id}`);
                
                if (data.status === 'success') {
                    renderLogList(container, data.log);
                } else {
                    container.innerHTML = `<p class="text-red-500">${data.message || 'Gagal memuat log.'}</p>`;
                }
            } catch (error) {
                console.error('Load Log error:', error);
                container.innerHTML = `<p class="text-red-500">Kesalahan jaringan: ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }

        function renderLogList(container, logList) {
            if (!logList || logList.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Log masih kosong.</p>';
                return;
            }

            let html = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            logList.slice().reverse().slice(0, 50).forEach(log => { // Show 50 newest logs
                html += `
                    <tr>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${log.timestamp}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs text-gray-500">${log.user}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-xs font-medium text-gray-900">${log.action}</td>
                        <td class="px-4 py-2 text-xs text-gray-500 break-all">${log.detail}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function loadArsipData() {
             const container = document.getElementById('arsip-list');
             container.innerHTML = '<p class="text-gray-500">Memuat link folder arsip...</p>';
            
             showLoading(true);
             try {
                 const data = await fetchWithRetry(`${GAS_API_URL}?action=get_arsip_link&userId=${currentUser.id}`);
                
                 if (data.status === 'success' && data.link) {
                     container.innerHTML = `
                         <p class="mb-4 text-gray-700">Akses semua file arsip Anda di Google Drive melalui link berikut:</p>
                         <a href="${data.link}" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-lg p-3 border rounded-lg bg-blue-50 inline-flex items-center space-x-2">
                             <i data-lucide="folder-open" class="w-6 h-6"></i>
                             <span>Buka Folder Arsip Google Drive</span>
                         </a>
                         <p class="mt-4 text-sm text-gray-500 italic">Catatan: Pastikan Anda login dengan akun Google yang memiliki akses ke folder tersebut.</p>
                     `;
                     lucide.createIcons();
                 } else {
                     container.innerHTML = `<p class="text-red-500">${data.message || 'Gagal memuat link arsip. Pastikan GAS sudah di-deploy dan terotorisasi ke Drive.'}</p>`;
                 }
             } catch (error) {
                 console.error('Load Arsip error:', error);
                 container.innerHTML = `<p class="text-red-500">Kesalahan jaringan: ${error.message}</p>`;
             } finally {
                 showLoading(false);
             }
         }
    </script>
</body>
</html>
